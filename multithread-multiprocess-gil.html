
<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="IE=edge" http-equiv="X-UA-Compatible"/>
<meta content="True" name="HandheldFriendly"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<meta content="index, follow" name="robots"/>
<link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:ital,wght@0,400;0,700;1,400&amp;family=Source+Sans+Pro:ital,wght@0,300;0,400;0,700;1,400&amp;display=swap" rel="stylesheet"/>
<link href="https://ycc.idv.tw/theme/stylesheet/style.less" rel="stylesheet/less" type="text/css"/>
<script src="//cdnjs.cloudflare.com/ajax/libs/less.js/2.5.1/less.min.js" type="text/javascript"></script>
<link href="https://ycc.idv.tw/theme/pygments/default.min.css" id="pygments-light-theme" rel="stylesheet" type="text/css"/>
<link href="https://ycc.idv.tw/theme/stork/stork.css" rel="stylesheet" type="text/css">
<link href="https://ycc.idv.tw/theme/font-awesome/css/fontawesome.css" rel="stylesheet" type="text/css"/>
<link href="https://ycc.idv.tw/theme/font-awesome/css/brands.css" rel="stylesheet" type="text/css"/>
<link href="https://ycc.idv.tw/theme/font-awesome/css/solid.css" rel="stylesheet" type="text/css"/>
<link href="/images/favicon.png" rel="shortcut icon" type="image/x-icon"/>
<link href="/images/favicon.png" rel="icon" type="image/x-icon"/>
<!-- Chrome, Firefox OS and Opera -->
<meta content="#FFFFFF" name="theme-color"/>
<!-- Windows Phone -->
<meta content="#FFFFFF" name="msapplication-navbutton-color"/>
<!-- iOS Safari -->
<meta content="yes" name="apple-mobile-web-app-capable"/>
<meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"/>
<!-- Microsoft EDGE -->
<meta content="#FFFFFF" name="msapplication-TileColor"/>
<link href="https://ycc.idv.tw/feeds/all.atom.xml" rel="alternate" title="YC Note Atom" type="application/atom+xml"/>
<script type="text/javascript">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-68393177-2', 'auto');
  ga('send', 'pageview');
</script>
<!-- Google tag (gtag.js) -->
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-LXDD9FZFX2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-LXDD9FZFX2');
</script>
<meta content="YC Chen" name="author">
<meta content="Python GIL 究竟怎麼影響我們應該採用Multi-thread或Multi-process？ Multi-thread和Multi-process又是什麼？什麼是CPU-bound和IO-bound呢？" name="description">
<meta content="CS, Python" name="keywords"/>
<meta content="YC Note" property="og:site_name">
<meta content="極簡說明Multi-thread/Multi-process、CPU-bound/IO-bound和GIL" property="og:title">
<meta content="Python GIL 究竟怎麼影響我們應該採用Multi-thread或Multi-process？ Multi-thread和Multi-process又是什麼？什麼是CPU-bound和IO-bound呢？" property="og:description">
<meta content="en_US" property="og:locale">
<meta content="https://ycc.idv.tw/multithread-multiprocess-gil.html" property="og:url"/>
<meta content="article" property="og:type"/>
<meta content="2022-11-26 12:00:00+08:00" property="article:published_time"/>
<meta content="" property="article:modified_time"/>
<meta content="https://ycc.idv.tw/author/yc-chen.html" property="article:author"/>
<meta content="CS" property="article:section">
<meta content="CS" property="article:tag"/>
<meta content="Python" property="article:tag"/>
<meta content="" property="og:image"/>
<title>YC Note – 極簡說明Multi-thread/Multi-process、CPU-bound/IO-bound和GIL</title>
<script async="" src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
    (adsbygoogle = window.adsbygoogle || []).push({
      google_ad_client: "ca-pub-5639899546876072",
      enable_page_level_ads: true
    });
  </script>
</meta></meta></meta></meta></meta></meta></meta></link><link href="https://ycc.idv.tw/multithread-multiprocess-gil.html" rel="canonical"/><script type="application/ld+json">{"@context": "https://schema.org", "@type": "BreadcrumbList", "itemListElement": [{"@type": "ListItem", "position": 1, "name": "YC Note", "item": "https://ycc.idv.tw"}, {"@type": "ListItem", "position": 2, "name": "Multithread multiprocess gil", "item": "https://ycc.idv.tw/multithread-multiprocess-gil.html"}]}</script><script type="application/ld+json">{"@context": "https://schema.org", "@type": "Article", "author": {"@type": "Person", "name": "YC Chen"}, "publisher": {"@type": "Organization", "name": "YC Note"}, "headline": "極簡說明Multi-thread/Multi-process、CPU-bound/IO-bound和GIL", "about": "CS", "datePublished": "2022-11-26 12:00"}</script></head>
<body class="light-theme">
<aside>
<div>
<a href="https://ycc.idv.tw/">
<img alt="YC Note" src="https://ycc.idv.tw/theme/img/profile.png" title="YC Note"/>
</a>
<h1>
<a href="https://ycc.idv.tw/">YC Note</a>
</h1>
<p style="text-align: center;">ML/DL Tech Blog (Total Views: 521,730) </p>
<div class="stork">
<input autocomplete="off" class="stork-input" data-stork="sitesearch" name="q" onclick="loadStorkIndex(this); this.onclick=null;" placeholder="Search (beta feature) ..." type="text"/>
<div class="stork-output" data-stork="sitesearch-output"></div>
</div>
<!-- <script>
      window.addEventListener('load', 
        function() { 
          loadStorkIndex();
        }, false);
    </script> -->
<p>Hello, I am YC, an ML engineer/researcher with experience in CV, NLP/NLU, and Recommender. I also have experience in high-QPS ML systems. In my spare time, I'm a blogger and guitar singer. <a href="https://ycc.idv.tw/about-me.html#anchor" style="color:yellow">More about me.</a></p>
<p>This blog is a resource for anyone interested in data science and machine learning, featuring tutorials, research papers, and the latest industry technologies.</p>
<ul class="social">
<li>
<a class="sc-facebook" href="https://www.facebook.com/yc.note" target="_blank">
<i class="fa-brands fa-facebook"></i>
</a>
</li>
<li>
<a class="sc-github" href="https://github.com/GitYCC" target="_blank">
<i class="fa-brands fa-github"></i>
</a>
</li>
<li>
<a class="sc-linkedin" href="https://www.linkedin.com/in/yi-chang-chen-aba1b6114/" target="_blank">
<i class="fa-brands fa-linkedin"></i>
</a>
</li>
</ul>
</div>
</aside>
<main>
<nav id="anchor">
<a href="https://ycc.idv.tw/">Home</a>
<a href="/about-me.html#anchor">About Me</a>
<a href="/category/aiml.html#anchor">AI.ML</a>
<a href="/category/cs.html#anchor">CS</a>
<a href="/categories.html#anchor">Categories</a>
<a href="/tags.html#anchor">Tags</a>
<a href="https://ycc.idv.tw/feeds/all.atom.xml">Atom</a>
</nav>
<article class="single">
<header>
<h1 id="multithread-multiprocess-gil">極簡說明Multi-thread/Multi-process、CPU-bound/IO-bound和GIL</h1>
<p>
      Posted on November 26, 2022 in <a href="https://ycc.idv.tw/category/cs.html">CS</a>. View: 1,829

    </p>
</header>
<div class="tag-cloud">
<p>
<a href="https://ycc.idv.tw/tag/cs.html">CS</a>
<a href="https://ycc.idv.tw/tag/python.html">Python</a>
</p>
</div>
<script async="" src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle ads-responsive" data-ad-client="ca-pub-5639899546876072" data-ad-slot="5718861428"></ins>
<script>
      (adsbygoogle = window.adsbygoogle || []).push({});
    </script>
<div class="main-contents">
<div class="toc"><span class="toctitle">Table of Contents</span><ul>
<li><a href="#tldr">TL;DR</a></li>
<li><a href="#multi-thread-and-multi-process">Multi-Thread and Multi-Process</a></li>
<li><a href="#cpu-bound-and-io-bound">CPU-bound and IO-bound</a></li>
<li><a href="#gil-global-interpreter-lock">GIL (Global Interpreter Lock)</a></li>
</ul>
</div>
<h3 id="tldr">TL;DR</h3>
<ul>
<li>Multi-Thread中每個Thread會共享資源，因此其優點是：資源利用較有效率、共享資源存取較快速</li>
<li>Multi-process將這些資源複製且隔離，其優點是：Process間不共享記憶體、程式碼比較好寫</li>
<li>特別注意：不管在 Multi-Thread 和 Multi-process 都可以吃到完整的多顆CPU，因為所有工作都會丟到OS Thread Scheduler，Scheduler會管控CPU的使用，但是Python可能有GIL需另外討論。</li>
<li>等待CPU計算較多的工作稱為CPU-bound Task，等待DMA拉資訊進記憶體較多的工作稱為IO-bound Task。</li>
<li>Python 在原始 default 的編譯器是採用CPython，而 CPython 採用了GIL，這導致了一個Python Job（一個Process）同一時間只能跑一個Thread。最終導致，CPython 的 Multi-thread 不能同時吃到多顆CPU，因此無法解決CPU-bound Task的問題。</li>
<li>粗略的原則：在CPython的情況下，遇到CPU-bound Task使用Multi-process，遇到 IO-bound Task使用Multi-thread。</li>
</ul>
<h3 id="multi-thread-and-multi-process">Multi-Thread and Multi-Process</h3>
<p><img alt="" src="/media/CS/IMG_thread_and_process.png"/></p>
<ul>
<li>Single Process Single Thread<ul>
<li>Single Process中記憶體存放Code、Data</li>
<li>Single Thread 進行中需使用 Stack 來追蹤紀錄</li>
</ul>
</li>
<li>Single Process Multi-Thread<ul>
<li>單一Process中的多個Thread共享資源（記憶體存放的Code、Data）</li>
<li>也因為共享資源的緣故，要小心撰寫程式碼避免dead lock和race condition等問題</li>
</ul>
</li>
<li>Multi-process<ul>
<li>每個Process都有自己一份的Code、Data，process彼此間不共享這些資源</li>
<li>所以開許多Process比較吃記憶體</li>
<li>而且如果想要讓Process之間共享資訊也會比較不容易，需要要做 serialize、memory copy、de-serialize 等等 OS 的開銷</li>
</ul>
</li>
<li>譬喻：<ul>
<li>Process 像是一間工廠，工廠裡面有許多器具（Code、Data）</li>
<li>Thread 像是裡頭的工人</li>
<li>Multi-Thread就像是一間工廠有多個工人，這樣的話那就需要避免他們互搶設備或互相等待</li>
<li>Multi-Process就像是蓋多間工廠，蓋更多工廠意味著更多的資本支出，而且工廠和工廠間要資源交換比較不容易</li>
</ul>
</li>
<li>Multi-Thread v.s. Multi-process<ul>
<li>Multi-Thread 優點：資源利用較有效率；共享資源存取較快速</li>
<li>Multi-Thread 缺點：因為共用記憶體，所以使用上要注意dead lock和race condition等問題；程式碼比較難寫</li>
<li>Multi-processing 優點：process之間不共享記憶體；程式碼比較好寫</li>
<li>Multi-processing 缺點：資源利用比較沒效率，較佔記憶體；共享資源需要額外開銷，有一些東西沒辦法serialize處理上就很麻煩；如果有跨Process的分享資源的話，仍需注意dead lock和race condition等問題</li>
</ul>
</li>
<li>特別注意：不管在 Multi-Thread 和 Multi-process 都可以吃到完整的多顆CPU，因為所有工作都會丟到OS Thread Scheduler，Scheduler會管控CPU的使用，但是Python情況特殊我們待會討論。</li>
</ul>
<h3 id="cpu-bound-and-io-bound">CPU-bound and IO-bound</h3>
<ul>
<li>CPU-bound<ul>
<li>當某個工作高度仰賴CPU計算，我們會稱之為CPU-bound Task</li>
</ul>
</li>
<li>IO-bound<ul>
<li>當某個工作大量等待外部存取（例如：從硬碟讀寫、網路溝通），我們會稱之為IO-bound Task</li>
<li>外部存取：意味著從外部將資訊拉近記憶體，此工作主要由DMA來完成，CPU在這過程並不需要參與，所以會有一段等待的時間</li>
<li>DMA（Direct Memory Access）允許某些電腦內部的硬體子系統，可以獨立地直接讀寫系統記憶體，而不需CPU介入處理 。很多硬體的系統會使用DMA，包含硬碟控制器、繪圖顯示卡、網路卡和音效卡。</li>
</ul>
</li>
</ul>
<h3 id="gil-global-interpreter-lock">GIL (Global Interpreter Lock)</h3>
<p><img alt="" src="/media/CS/IMG_cpython_thread_and_process.png"/></p>
<ul>
<li>Python 在原始 default 的編譯器是採用CPython，而 CPython 採用了GIL，這導致了一個Python Job（一個Process）同一時間只能跑一個Thread，這意味著就算有多顆CPU的存在，同時間還是沒辦法吃一顆以上的CPU，也因此會有以下情況。</li>
<li>當我們需要處理CPU-bound Task時，如果採用Multi-thread，因為GIL的緣故導致無法同時使用多顆CPU，也因此計算效能無法提升。相反如果採用Multi-process，因為開了好幾個Process，每個Process都有自己獨立的GIL，因此才能吃到多顆CPU，進而解決CPU-bound的問題。</li>
<li>當我們需要處理IO-bound Task時，如果採用Multi-thread，因為CPU的使用量並不高，大部分thread的時間都是在等待IO，所以多個thread其實就足夠解決IO-bound問題。當然如果使用Multi-process也是可以做到，但是這會多造成資源的浪費。</li>
</ul>
</div>
<div class="center social-share">
<p>Like this article? Share it with your friends!</p>
<div class="addthis_native_toolbox"></div>
<div class="addthis_sharing_toolbox"></div>
<div class="addthis_inline_share_toolbox"></div>
</div>
<div class="neighbors">
<a class="btn float-left" href="https://ycc.idv.tw/tesla-aiday2022.html#anchor" title="Tesla AI Day 2022 筆記">
<i class="fa fa-angle-left"></i> Previous Post
    </a>
<a class="btn float-right" href="https://ycc.idv.tw/about-me.html#anchor" title="About Me: Yi-Chang Chen">
      Next Post <i class="fa fa-angle-right"></i>
</a>
</div>
<div class="related-posts">
<h4>You might enjoy</h4>
<ul class="related-posts">
<li><a href="https://ycc.idv.tw/introduction-object-oriented-programming_2.html">物件導向武功秘笈（2）：招式篇 — Python與Java的物件導向編程介紹</a></li>
<li><a href="https://ycc.idv.tw/python-play-with-data_3.html">Python玩數據 (3)：Numpy [2/2]</a></li>
<li><a href="https://ycc.idv.tw/python-play-with-data_2.html">Python玩數據 (2)：Numpy [1/2]</a></li>
<li><a href="https://ycc.idv.tw/python-play-with-data_1.html">Python玩數據 (1)：安裝Python, IPython, Numpy, Pandas</a></li>
</ul>
</div>
<!-- Disqus -->
<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'ycnote-1';
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>
    Please enable JavaScript to view comments.
</noscript>
<!-- End Disqus -->
</article>
<footer>
<p>
  © 2023  - This work is licensed under a <a href="http://creativecommons.org/licenses/by-sa/4.0/deed.en_US" rel="license" target="_blank">Creative Commons Attribution-ShareAlike 4.0 International License</a>
</p>
<p>
Built with <a href="http://getpelican.com" target="_blank">Pelican</a> using <a href="http://bit.ly/flex-pelican" target="_blank">Flex</a> theme
</p><p>
<a href="http://creativecommons.org/licenses/by-sa/4.0/" rel="license" target="_blank">
<img alt="Creative Commons License" height="15" src="https://i.creativecommons.org/l/by-sa/4.0/80x15.png" style="border-width:0" title="Creative Commons License" width="80"/>
</a>
</p></footer> </main>
<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " YC Note ",
  "url" : "https://ycc.idv.tw",
  "image": "",
  "description": "[ YC Note - ML/DL Tech Blog ] Hello, I am YC, an ML engineer/researcher with experience in CV, NLP/NLU, and Recommender. I built this blog for anyone interested in data science and machine learning."
}
</script><script async="async" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-63b4eabb5e84e9fb" type="text/javascript"></script>
<script>
    window.loadStorkIndex = async (input_obj) => {
      input_obj.disabled = true;
      input_obj.placeholder = 'Downloading index file, please wait ...'
      await stork.register("sitesearch", "https://ycc.idv.tw/search-index.st", { showProgress: false });
      input_obj.placeholder = 'Search ...'
      input_obj.disabled = false;
    }
  </script>
<script src="https://files.stork-search.net/releases/v1.5.0/stork.js"></script>
</body>
</html>