<!DOCTYPE html>
<html lang="zh">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="description" content="Autoencoderæ˜¯ä¸€å€‹Neurel Networké‡è¦çš„å·¥å…·ï¼Œæˆ‘å€‹äººèªç‚ºå®ƒé‚„æ¼‚äº®çš„å‘ˆç¾Neurel Networkçš„å¼·å¤§ã€‚ æœ¬å–®å…ƒç¨‹å¼ç¢¼Autoencoderéƒ¨åˆ†å¯æ–¼Githubä¸‹è¼‰ï¼ŒDe-noise Autoencoderéƒ¨åˆ†å¯æ–¼Githubä¸‹è¼‰ã€‚ Autoencoderè§€å¿µè§£æ åœ¨ã€Œæ©Ÿå™¨å­¸ç¿’æŠ€æ³•ã€çš„ç³»åˆ—æ–‡ç« ï¼Œæˆ‘ä¹Ÿæ›¾ç¶“ä»‹ç´¹éAutoencoderï¼Œå¯ä»¥æ­é…é€™ç¯‡æœç”¨ã€‚...">
        <meta name="keywords" content="Tensorflow">
        <link rel="icon" href="./static/img/favicon.png">

        <title>å¯¦ä½œTensorflow (4)ï¼šAutoencoder - YC Note</title>

        <!-- Stylesheets -->
        <link href="./theme/css/all.min.css" rel="stylesheet">
        <!-- /Stylesheets -->

        <!-- RSS Feeds -->
        <link href="YCNote/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="YC Note Full Atom Feed" />
        <link href="YCNote/feeds/aiml.atom.xml" type="application/atom+xml" rel="alternate" title="YC Note Categories Atom Feed" />
        <!-- /RSS Feeds -->

        <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
          <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
          <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
        <![endif]-->



    </head>

    <body>

        <!-- Header -->
    <div class="header-container" style="background: linear-gradient(rgba(0, 0, 0, 0.2), rgba(0, 0, 0, 0.2)), url('./images/tensorflow-logo.jpg'); background-position: center; background-size: cover;">

            <!-- Static navbar -->
            <div class="container">
                <div class="header-nav">
                    <div class="header-logo">
                        <a class="pull-left" href="./"><img class="logo" src="./static/img/favicon.png" alt="logo">YC Note</a>
                    </div>
                    <div class="nav pull-right">
                                <a href="./category/coding.html">Coding</a>
                                <a href="./category/aiml.html">AI.ML</a>
                                <a href="./category/reading.html">Reading</a>
                                <a href="./category/recording.html">Recording</a>
                                <a href="./about-me.html">About Me</a>
                    </div>
                </div>
            </div>
            <!-- /Static navbar -->

            <!-- Header -->
    <!-- Header -->
    <div class="container header-wrapper">
        <div class="row">
              <div class="col-lg-12">
                  <div class="header-content">
                      <h1 class="header-title">å¯¦ä½œTensorflow (4)ï¼šAutoencoder</h1>
                      <p class="header-date">By <a href="./author/yc-chen.html">YC Chen</a>, 2017 / 11æœˆ 18, in category <a href="./category/aiml.html">Ai.ml</a></p>
                      <div class="header-underline"></div>
                      <div class="clearfix"></div>
                      <p class="pull-right header-tags">
                          <span class="glyphicon glyphicon-tags mr5" aria-hidden="true"></span>
<a href="./tag/tensorflow.html">Tensorflow</a>                      </p>
                  </div>
              </div>
        </div>
    </div>
    <!-- /Header -->
            <!-- /Header -->

        </div>
        <!-- /Header -->


        <!-- Content -->
    <div class="container content">
        <p>Autoencoderæ˜¯ä¸€å€‹Neurel Networké‡è¦çš„å·¥å…·ï¼Œæˆ‘å€‹äººèªç‚ºå®ƒé‚„æ¼‚äº®çš„å‘ˆç¾Neurel Networkçš„å¼·å¤§ã€‚</p>
<p>æœ¬å–®å…ƒç¨‹å¼ç¢¼Autoencoderéƒ¨åˆ†å¯æ–¼<a href="https://github.com/GitYCC/Tensorflow_Tutorial/blob/master/code/04_1_Autoencoder_on_MNIST.py">Github</a>ä¸‹è¼‰ï¼ŒDe-noise Autoencoderéƒ¨åˆ†å¯æ–¼<a href="https://github.com/GitYCC/Tensorflow_Tutorial/blob/master/code/04_2_DenoiseAutoencoder_on_MNIST.py">Github</a>ä¸‹è¼‰ã€‚</p>
<p><br/></p>
<h3>Autoencoderè§€å¿µè§£æ</h3>
<p>åœ¨ã€Œæ©Ÿå™¨å­¸ç¿’æŠ€æ³•ã€çš„ç³»åˆ—æ–‡ç« ï¼Œæˆ‘ä¹Ÿ<a href="http://www.ycc.idv.tw/YCNote/post/35">æ›¾ç¶“ä»‹ç´¹éAutoencoder</a>ï¼Œå¯ä»¥æ­é…é€™ç¯‡æœç”¨ã€‚</p>
<p>Autoencoderæ¦‚å¿µå¾ˆç°¡å–®ï¼Œå°±æ˜¯åšè³‡è¨Šçš„å£“ç¸®ï¼Œæ¦‚å¿µæ˜¯é€™æ¨£çš„ï¼Œç•¶æˆ‘åœ¨ä¸€å±¤ç•¶ä¸­ä½¿ç”¨ç¥ç¶“å…ƒæ„ˆå¤šï¼Œå¯ä»¥å„²å­˜çš„è³‡è¨Šé‡ä¹Ÿå°±æ„ˆå¤šï¼Œç›¸åçš„ç¥ç¶“å…ƒè¶Šå°‘ï¼Œå¯ä»¥å„²å­˜çš„è³‡è¨Šé‡è¶Šå°‘ï¼Œå¦‚æœæˆ‘è¦ä½¿ç”¨Neurel Networkä½œè³‡æ–™å£“ç¸®çš„è©±ï¼Œæˆ‘å¸Œæœ›çš„æ˜¯å¯ä»¥ä½¿ç”¨æ¯”åŸæœ¬æ›´å°‘çš„è³‡è¨Šé‡ä¾†å„²å­˜ï¼Œå¦‚æœåŸæœ¬æ˜¯ä¸€å¼µMNISTçš„åœ–ï¼Œæœ‰28x28=784å€‹Pixelsï¼Œæ‰€ä»¥å¯ä»¥æƒ³çŸ¥ï¼Œå¦‚æœæˆ‘è¦ä½œå£“ç¸®å°±è¦ä½¿å¾—å£“ç¸®å¾Œçš„ç¥ç¶“å…ƒå¯ä»¥æ¯”784å€‹æ›´å°‘ã€‚</p>
<p>ä½†æ˜¯ä»€éº¼éƒ½ä¸åšæˆ‘å€‘å°±å¯ä»¥å¹³ç™½ç„¡æ•…çš„åšåˆ°å£“ç¸®ï¼Ÿç•¶ç„¶ä¸è¡Œï¼Œæˆ‘å€‘é‚„å¾—å¾è³‡æ–™ä¸­æ‰¾åˆ°ä¸€äº›è¦å¾‹ï¼Œå¥—ç”¨é€™äº›è¦å¾‹æŠŠå¤šé¤˜çš„æ±è¥¿å»é™¤ï¼Œç•™ä¸‹ç²¾é«“ï¼Œæˆ‘å€‘æ‰å¯ä»¥æŠŠè³‡æ–™ä½œå£“ç¸®ï¼Œæ‰€ä»¥åœ¨å¯¦ä½œä¸Šæˆ‘å€‘æœƒå»ºç«‹ä¸€å€‹ç¥ç¶“å…ƒç”±å¤§åˆ°å°çš„Neurel Networkï¼Œé€æ­¥çš„è½‰æ›ï¼Œé€æ­¥çš„å£“ç¸®è³‡è¨Šã€‚</p>
<p>é‚£éº¼å£“ç¸®çš„ç›®çš„æ˜¯ç‚ºäº†ä»€éº¼ï¼Ÿç•¶ç„¶æ˜¯æœ‰è¾¦æ³•é‚„åŸå›å»åŸæœ¬ç‹€æ…‹ï¼Œé€™æ¨£çš„å£“ç¸®æ‰æ˜¯æœ‰æ„ç¾©çš„ï¼Œä¾‹å¦‚ï¼šå°‡æ–‡æª”æ‰“åŒ…æˆRARï¼Œæª”æ¡ˆå¤§å°æœƒè®Šå°ï¼Œä½†å¦‚æœå¯¦éš›è¦å†ä½¿ç”¨é€™å€‹æª”æ¡ˆï¼Œé‚£å°±å¿…é ˆå…ˆåšè§£å£“ç¸®ï¼Œç„¶å¾Œé‚„åŸå›å»åŸæœ¬çš„æª”æ¡ˆï¼Œé€™è£¡çš„é‚„åŸç‡å¿…é ˆæ˜¯ç™¾åˆ†ä¹‹ä¸€ç™¾çš„ï¼ŒAutoencoderä¸€æ¨£çš„æœ‰ä¸€å€‹æ©Ÿåˆ¶å¯ä»¥é‚„åŸï¼Œåœ¨å¯¦ä½œä¸Šæˆ‘å€‘æœƒå»ºç«‹ä¸€å€‹ç¥ç¶“å…ƒç”±å°åˆ°å¤§çš„Neurel Networkï¼Œé€æ­¥çš„é‚„åŸå›å»åŸæœ¬çš„ç‹€æ…‹ã€‚</p>
<p>å› æ­¤ä¸€å€‹Autoencoderçš„åœ–åƒå°±å‡ºç¾äº†ï¼Œæˆ‘å€‘éœ€è¦æœ‰ä¸€çµ„ã€ŒEncoderã€ä¾†é€æ­¥çš„å£“ç¸®ï¼Œæœ€å¾Œç•™ä¸‹éå¸¸ç²¾ç°¡çš„ã€ŒEmbedding Codeã€ï¼Œè€Œé€™çµ„ã€ŒEmbedding Codeã€å¯ä»¥å†ç¶“ç”±ã€ŒDecoderã€é‚„åŸå›å»åŸæœ¬çš„æ¨£å­ï¼Œé‚£æˆ‘å€‘æ€éº¼è®“ä»–è‡ªå·±ç”¢ç”Ÿã€ŒEncoderã€å’Œã€ŒDecoderã€å‘¢ï¼ŸæŠŠåŸæœ¬çš„Inputç•¶ä½œOutputçš„ç›®æ¨™ç­”æ¡ˆå»è¨“ç·´Neurel Networkå°±å¯ä»¥äº†ï¼Œé€™å°±æ˜¯Autoencoderå·§å¦™çš„åœ°æ–¹ã€‚</p>
<p>ä¸ç®¡æ˜¯ã€ŒEncoderã€é‚„æ˜¯ã€ŒDecoderã€ä»–å€‘çš„æ¬Šé‡æ˜¯å¯ä»¥èª¿æ•´çš„ï¼Œæ‰€ä»¥å¦‚æœä½ å°‡Encoder+Decoderçš„çµæ§‹å»ºç«‹å¥½ä¸¦æ­é…Inputç•¶ä½œOutputçš„ç›®æ¨™ç­”æ¡ˆï¼Œå®ƒåœ¨Trainingçš„éç¨‹ï¼ŒAutoencoderæœƒè©¦è‘—æ‰¾å‡ºæœ€å¥½çš„æ¬Šé‡ä¾†ä½¿å¾—è³‡è¨Šå¯ä»¥ç›¡é‡å®Œæ•´é‚„åŸå›å»ï¼Œæ‰€ä»¥Autoencoderå¯ä»¥è‡ªè¡Œæ‰¾å‡ºäº†Encoderå’ŒDecoderã€‚</p>
<p>Encoderçš„æ•ˆæœç­‰åŒæ–¼åšDimension Reductionï¼ŒEncoderè½‰æ›åŸæœ¬æ•¸æ“šåˆ°ä¸€å€‹æ–°çš„ç©ºé–“ï¼Œé€™å€‹ç©ºé–“å¯ä»¥æ¯”åŸæœ¬Featuresæè¿°çš„ç©ºé–“æ›´èƒ½ç²¾ç°¡çš„æè¿°é€™ç¾¤æ•¸æ“šï¼Œè€Œä¸­é–“é€™å±¤Layerçš„æ•¸å€¼Embedding Codeå°±æ˜¯æ–°ç©ºé–“è£¡é ­çš„åº§æ¨™ï¼Œæœ‰äº›æ™‚å€™æˆ‘å€‘æœƒç”¨é€™å€‹æ–°ç©ºé–“ä¾†åˆ¤æ–·æ¯ç­†Dataä¹‹é–“å½¼æ­¤çš„æ¥è¿‘ç¨‹åº¦ã€‚</p>
<p><img alt="autoencoder" src="https://github.com/GitYCC/Tensorflow_Tutorial/blob/master/img/TensorflowTutorial.007.jpeg?raw=true"></p>
<p><br/></p>
<h3>Autoencoderç¨‹å¼ç¢¼</h3>
<p>å¯¦ç¾Autoencoderå’Œä¹‹å‰DNNä¸¦æ²’æœ‰å¤ªå¤§çš„å·®ç•°ï¼Œåªæœ‰å…©é»è¦ç‰¹åˆ¥æé†’ä¸€ä¸‹ã€‚</p>
<p>ç¬¬ä¸€é»ï¼Œä»¥ä¸‹æˆ‘æœƒç‰¹åˆ¥æŠŠ<code>encoder</code>é¡å¤–çš„åœ¨<code>structure</code>è£¡é ­è¼¸å‡ºå‡ºä¾†ï¼Œä¸¦ä¸”å¢åŠ æ–°çš„å‡½æ•¸<code>encode</code>ï¼Œè®“ä½¿ç”¨è€…å¯ä»¥ä½¿ç”¨Trainå¥½çš„Encoderä¾†åšEncodeã€‚</p>
<p>ç¬¬äºŒé»ï¼Œä»¥ä¸‹çš„Regularizerä¸æ˜¯æ¡ç”¨å–®ç´”çš„L2 Regularizerï¼Œæˆ‘å°‡æœƒä½¿ç”¨Weight-Elimination L2 Regularizerï¼Œé€™å€‹Regularizerçš„å¥½è™•æ˜¯æœƒä½¿å¾—æ¬Šé‡æ¥è¿‘Sparseï¼Œä¹Ÿå°±æ˜¯èªªæ¬Šé‡æœƒç•™ä¸‹æ¯”è¼ƒå¤šçš„0ï¼Œé€™æœ‰ä¸€å€‹å¥½è™•ï¼Œå°±æ˜¯æ¯å€‹ç¥ç¶“å…ƒå½¼æ­¤ä¹‹é–“çš„ä¾è³´æ¸›å°‘äº†ï¼Œå› ç‚ºå…§ç©(è©•ä¼°ç›¸ä¾æ€§)æ™‚æœ‰0çš„é‚£å€‹ç¶­åº¦å°‡ä¸æœƒæœ‰æ‰€è²¢ç»ã€‚</p>
<p>Weight-Elimination L2 Regularizeræœ‰é€™æ¨£çš„æ•ˆæœåŸå› æ˜¯é€™æ¨£çš„ï¼ŒL2 Regularizeråœ¨æŠ‘åˆ¶Wçš„æ–¹æ³•æ˜¯ï¼Œå¦‚æœWçš„åˆ†é‡å¤§çš„è©±å°±æŠ‘åˆ¶å¤šä¸€é»ï¼Œå¦‚æœåˆ†é‡å°å°±æŠ‘åˆ¶å°‘ä¸€é»ï¼ˆå› ç‚ºW<sup>2</sup>å¾®åˆ†ç‚ºä¸€æ¬¡ï¼‰ï¼Œæ‰€ä»¥æœ€å¾Œæœƒç•™ä¸‹å¾ˆå¤šä¸ç‚º0çš„å¾®å°åˆ†é‡ï¼Œä¸å¤ Sparseï¼Œé€™æ¨£çš„Regularizationé¡¯ç„¶ä¸å¤ å¥½ï¼ŒL1 Regularizerå¯ä»¥è§£æ±ºé€™å€‹å•é¡Œï¼ˆå› ç‚ºåœ¨å¤§éƒ¨åˆ†ä½ç½®å¾®åˆ†ç‚ºå¸¸æ•¸ï¼‰ï¼Œä½†ä¸å¹¸çš„æ˜¯å®ƒç„¡æ³•å¾®åˆ†ï¼Œæ²’è¾¦æ³•ä½œBackpropagationï¼Œæ‰€ä»¥å°±æœ‰äº†L2 Regularizerçš„è¡ç”Ÿç‰ˆæœ¬ï¼Œ</p>
<p>Weight-elimination L2 regularizer: ğšº[(W<sub>jk</sub>(â„“))<sup>2</sup>]/[1+(W<sub>jk</sub>(â„“))<sup>2</sup>]</p>
<p>é€™éº¼ä¸€ä¾†ä¸ç®¡Wå¤§æˆ–å°ï¼Œå®ƒå—åˆ°æŠ‘åˆ¶çš„å€¼å¤§å°æ¥è¿‘çš„ (Weight-elimination L2 regularizerå¾®åˆ†ç‚º -1æ¬¡æ–¹)ï¼Œå› æ­¤å°±å¯ä»¥ä½¿å¾—éƒ¨åˆ†Wå¯ä»¥ç‚º0ï¼Œé”æˆSparseçš„ç›®çš„ã€‚</p>
<p>é‚£ç‚ºä»€éº¼æˆ‘è¦ç‰¹åˆ¥åœ¨Autoencoderè¬›ç©¶Sparseç‰¹æ€§å‘¢ï¼ŸåŸå› æ˜¯æˆ‘å€‘ç¾åœ¨æ­£åœ¨åšçš„äº‹æ˜¯Dimension Reductionï¼Œåšé€™ä»¶äº‹å°±å¥½åƒæ˜¯æ›¿åŸæœ¬ç©ºé–“æ‰¾å‡ºæ–°çš„è»¸ï¼Œè€Œé€™å€‹è»¸çš„æ•¸é‡æ¯”åŸæœ¬ç©ºé–“è»¸çš„æ•¸é‡ä¾†å¾—å°ï¼Œé”åˆ°Dimension Reductionçš„æ•ˆæœï¼Œæ‰€ä»¥æˆ‘å€‘æœƒå¸Œæœ›é€™å€‹æ–°çš„è»¸å½¼æ­¤é–“å¯ä»¥ä¸è¦å¤ªå¤šçš„ä¾è³´ï¼Œä»€éº¼æ˜¯ä¸ä¾è³´å‘¢ï¼Ÿç›´è§’åº§æ¨™å°±æ˜¯æœ€ä¸ä¾è³´çš„åº§æ¨™ç³»ï¼ŒXè»¸å’ŒYè»¸å…§ç©ç‚º0ï¼Œé€™æ¨£çš„è»¸å±•é–‹çš„æ•ˆç‡æ˜¯æœ€å¥½çš„ï¼Œæ‰€ä»¥æˆ‘å€‘å¸Œæœ›åœ¨åšRegularizationçš„åŒæ™‚å¯ä»¥æ¸›å°‘æ–°è»¸çš„å½¼æ­¤é–“çš„ä¾è³´æ€§ã€‚</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="kn">as</span> <span class="nn">tf</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">random</span><span class="o">,</span> <span class="nn">time</span>

<span class="c1"># Config the matplotlib backend as plotting inline in IPython</span>
<span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Autoencoder</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">n_features</span><span class="p">,</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">n_hidden</span><span class="o">=</span><span class="p">[</span><span class="mi">1000</span><span class="p">,</span><span class="mi">500</span><span class="p">,</span><span class="mi">250</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_features</span> <span class="o">=</span> <span class="n">n_features</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">biases</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">graph</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span> <span class="c1"># initialize new grap</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">n_features</span><span class="p">,</span><span class="n">learning_rate</span><span class="p">,</span><span class="n">n_hidden</span><span class="p">,</span><span class="n">alpha</span><span class="p">)</span> <span class="c1"># building graph</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sess</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Session</span><span class="p">(</span><span class="n">graph</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="p">)</span> <span class="c1"># create session by the graph </span>

    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">n_features</span><span class="p">,</span><span class="n">learning_rate</span><span class="p">,</span><span class="n">n_hidden</span><span class="p">,</span><span class="n">alpha</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">as_default</span><span class="p">():</span>
            <span class="c1">### Input</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">train_features</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">placeholder</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span><span class="n">n_features</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">train_targets</span>  <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">placeholder</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span><span class="n">n_features</span><span class="p">))</span>

            <span class="c1">### Optimalization</span>
            <span class="c1"># build neurel network structure and get their predictions and loss</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">y_</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">original_loss</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">(</span>
                                               <span class="n">features</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">train_features</span><span class="p">,</span>
                                               <span class="n">targets</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">train_targets</span><span class="p">,</span>
                                               <span class="n">n_hidden</span><span class="o">=</span><span class="n">n_hidden</span><span class="p">)</span>

            <span class="c1"># regularization loss</span>
            <span class="c1"># weight elimination L2 regularizer</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">regularizer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">([</span><span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span>
                        <span class="n">tf</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">w</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">tf</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">w</span><span class="p">,</span><span class="mi">2</span><span class="p">)))</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span> \
                    <span class="o">/</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span>
                     <span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">w</span><span class="p">,</span><span class="n">out_type</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>

            <span class="c1"># total loss</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">original_loss</span> <span class="o">+</span> <span class="n">alpha</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">regularizer</span>

            <span class="c1"># define training operation</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">AdamOptimizer</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="n">learning_rate</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">train_op</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loss</span><span class="p">)</span>

            <span class="c1">### Prediction</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">new_features</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">placeholder</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span><span class="n">n_features</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">new_targets</span>  <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">placeholder</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span><span class="n">n_features</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">new_y_</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_original_loss</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_encoder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">(</span>
                                                          <span class="n">features</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">new_features</span><span class="p">,</span>
                                                          <span class="n">targets</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">new_targets</span><span class="p">,</span>
                                                          <span class="n">n_hidden</span><span class="o">=</span><span class="n">n_hidden</span><span class="p">)</span>  
            <span class="bp">self</span><span class="o">.</span><span class="n">new_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_original_loss</span> <span class="o">+</span> <span class="n">alpha</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">regularizer</span>

            <span class="c1">### Initialization</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">init_op</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">global_variables_initializer</span><span class="p">()</span>  

    <span class="k">def</span> <span class="nf">structure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">features</span><span class="p">,</span><span class="n">targets</span><span class="p">,</span><span class="n">n_hidden</span><span class="p">):</span>
        <span class="c1">### Variable</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">biases</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">biases</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="n">n_encoder</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">n_features</span><span class="p">]</span><span class="o">+</span><span class="n">n_hidden</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">n</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">n_encoder</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="s1">&#39;encode{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> \
                    <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">truncated_normal</span><span class="p">(</span>
                        <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">n_encoder</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]),</span><span class="n">stddev</span><span class="o">=</span><span class="mf">0.1</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">biases</span><span class="p">[</span><span class="s1">&#39;encode{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> \
                    <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">n_encoder</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span> <span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

            <span class="n">n_decoder</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">n_hidden</span><span class="p">))</span><span class="o">+</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">n_features</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">n</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">n_decoder</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="s1">&#39;decode{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> \
                    <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">truncated_normal</span><span class="p">(</span>
                        <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">n_decoder</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]),</span><span class="n">stddev</span><span class="o">=</span><span class="mf">0.1</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">biases</span><span class="p">[</span><span class="s1">&#39;decode{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> \
                    <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">n_decoder</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span> <span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>                    

        <span class="c1">### Structure</span>
        <span class="n">activation</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">relu</span>

        <span class="n">encoder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getDenseLayer</span><span class="p">(</span><span class="n">features</span><span class="p">,</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="s1">&#39;encode1&#39;</span><span class="p">],</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">biases</span><span class="p">[</span><span class="s1">&#39;encode1&#39;</span><span class="p">],</span>
                                     <span class="n">activation</span><span class="o">=</span><span class="n">activation</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">n_hidden</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">encoder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getDenseLayer</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="s1">&#39;encode{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)],</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">biases</span><span class="p">[</span><span class="s1">&#39;encode{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)],</span>
                        <span class="n">activation</span><span class="o">=</span><span class="n">activation</span><span class="p">)</span>   

        <span class="n">encoder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getDenseLayer</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="s1">&#39;encode{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">n_hidden</span><span class="p">))],</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">biases</span><span class="p">[</span><span class="s1">&#39;encode{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">n_hidden</span><span class="p">))])</span> 

        <span class="n">decoder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getDenseLayer</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="s1">&#39;decode1&#39;</span><span class="p">],</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">biases</span><span class="p">[</span><span class="s1">&#39;decode1&#39;</span><span class="p">],</span>
                                     <span class="n">activation</span><span class="o">=</span><span class="n">activation</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">n_hidden</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">decoder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getDenseLayer</span><span class="p">(</span><span class="n">decoder</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="s1">&#39;decode{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)],</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">biases</span><span class="p">[</span><span class="s1">&#39;decode{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)],</span>
                        <span class="n">activation</span><span class="o">=</span><span class="n">activation</span><span class="p">)</span> 

        <span class="n">y_</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">getDenseLayer</span><span class="p">(</span><span class="n">decoder</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="s1">&#39;decode{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">n_hidden</span><span class="p">))],</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">biases</span><span class="p">[</span><span class="s1">&#39;decode{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">n_hidden</span><span class="p">))],</span>
                        <span class="n">activation</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">)</span>      

        <span class="n">loss</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">targets</span> <span class="o">-</span> <span class="n">y_</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">y_</span><span class="p">,</span><span class="n">loss</span><span class="p">,</span><span class="n">encoder</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">getDenseLayer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">input_layer</span><span class="p">,</span><span class="n">weight</span><span class="p">,</span><span class="n">bias</span><span class="p">,</span><span class="n">activation</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">input_layer</span><span class="p">,</span><span class="n">weight</span><span class="p">),</span><span class="n">bias</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">activation</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">activation</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span>


    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">epochs</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">validation_data</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">test_data</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">batch_size</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">X</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_array</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="n">Y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_array</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>

        <span class="n">N</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">9000</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">batch_size</span><span class="p">:</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">N</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">init_op</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">epochs</span><span class="p">):</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Epoch </span><span class="si">%2d</span><span class="s2">/</span><span class="si">%2d</span><span class="s2">: &quot;</span><span class="o">%</span><span class="p">(</span><span class="n">epoch</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">epochs</span><span class="p">))</span>
            <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

            <span class="c1"># mini-batch gradient descent</span>
            <span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)]</span>
            <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
            <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">index</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">index_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
                <span class="n">batch_index</span> <span class="o">=</span> <span class="p">[</span><span class="n">index</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span><span class="n">index_size</span><span class="p">))]</span>     

                <span class="n">feed_dict</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">train_features</span><span class="p">:</span> <span class="n">X</span><span class="p">[</span><span class="n">batch_index</span><span class="p">,:],</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">train_targets</span><span class="p">:</span> <span class="n">Y</span><span class="p">[</span><span class="n">batch_index</span><span class="p">,:]}</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">train_op</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss</span><span class="p">],</span> <span class="n">feed_dict</span><span class="o">=</span><span class="n">feed_dict</span><span class="p">)</span>

                <span class="k">print</span><span class="p">(</span><span class="s2">&quot;[</span><span class="si">%d</span><span class="s2">/</span><span class="si">%d</span><span class="s2">] loss = </span><span class="si">%9.4f</span><span class="s2">     &quot;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">N</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">index</span><span class="p">),</span> <span class="n">N</span><span class="p">,</span> <span class="n">loss</span> <span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">)</span>


            <span class="c1"># evaluate at the end of this epoch</span>
            <span class="n">msg_valid</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">if</span> <span class="n">validation_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">val_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">validation_data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">validation_data</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">msg_valid</span> <span class="o">=</span> <span class="s2">&quot;, val_loss = </span><span class="si">%9.4f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">val_loss</span> <span class="p">)</span>

            <span class="n">train_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;[</span><span class="si">%d</span><span class="s2">/</span><span class="si">%d</span><span class="s2">] </span><span class="si">%d</span><span class="s2">s loss = </span><span class="si">%9.4f</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">start_time</span><span class="p">,</span>
                                                   <span class="n">train_loss</span><span class="p">,</span> <span class="n">msg_valid</span> <span class="p">))</span>

        <span class="k">if</span> <span class="n">test_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">test_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">test_data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">test_data</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;test_loss = </span><span class="si">%9.4f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">test_loss</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">encode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">X</span><span class="p">):</span>
        <span class="n">X</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_array</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">new_encoder</span><span class="p">,</span> <span class="n">feed_dict</span><span class="o">=</span><span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">new_features</span><span class="p">:</span> <span class="n">X</span><span class="p">})</span>

    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">X</span><span class="p">):</span>
        <span class="n">X</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_array</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">new_y_</span><span class="p">,</span> <span class="n">feed_dict</span><span class="o">=</span><span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">new_features</span><span class="p">:</span> <span class="n">X</span><span class="p">})</span>

    <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">):</span>
        <span class="n">X</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_array</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">new_loss</span><span class="p">,</span> <span class="n">feed_dict</span><span class="o">=</span><span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">new_features</span><span class="p">:</span> <span class="n">X</span><span class="p">,</span>
                                                       <span class="bp">self</span><span class="o">.</span><span class="n">new_targets</span><span class="p">:</span> <span class="n">Y</span><span class="p">})</span>

    <span class="k">def</span> <span class="nf">_check_array</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ndarray</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ndarray</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span> <span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">ndarray</span><span class="p">,(</span><span class="mi">1</span><span class="p">,</span><span class="n">ndarray</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="k">return</span> <span class="n">ndarray</span>
</pre></div>


<p><br/></p>
<h3>æ¸¬è©¦Autoencoder</h3>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tensorflow.examples.tutorials.mnist</span> <span class="kn">import</span> <span class="n">input_data</span>
<span class="n">mnist</span> <span class="o">=</span> <span class="n">input_data</span><span class="o">.</span><span class="n">read_data_sets</span><span class="p">(</span><span class="s2">&quot;MNIST_data/&quot;</span><span class="p">,</span> <span class="n">one_hot</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="n">train_data</span> <span class="o">=</span> <span class="n">mnist</span><span class="o">.</span><span class="n">train</span>
<span class="n">valid_data</span> <span class="o">=</span> <span class="n">mnist</span><span class="o">.</span><span class="n">validation</span>
<span class="n">test_data</span> <span class="o">=</span> <span class="n">mnist</span><span class="o">.</span><span class="n">test</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="n">model_1</span> <span class="o">=</span> <span class="n">Autoencoder</span><span class="p">(</span> <span class="n">n_features</span><span class="o">=</span><span class="mi">28</span><span class="o">*</span><span class="mi">28</span><span class="p">,</span>
                     <span class="n">learning_rate</span><span class="o">=</span> <span class="mf">0.0005</span><span class="p">,</span>
                     <span class="n">n_hidden</span><span class="o">=</span><span class="p">[</span><span class="mi">512</span><span class="p">,</span><span class="mi">32</span><span class="p">,</span><span class="mi">4</span><span class="p">],</span>
                     <span class="n">alpha</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                    <span class="p">)</span>
<span class="n">model_1</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">train_data</span><span class="o">.</span><span class="n">images</span><span class="p">,</span>
           <span class="n">Y</span><span class="o">=</span><span class="n">train_data</span><span class="o">.</span><span class="n">images</span><span class="p">,</span>
           <span class="n">epochs</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
           <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">valid_data</span><span class="o">.</span><span class="n">images</span><span class="p">,</span><span class="n">valid_data</span><span class="o">.</span><span class="n">images</span><span class="p">),</span>
           <span class="n">test_data</span><span class="o">=</span><span class="p">(</span><span class="n">test_data</span><span class="o">.</span><span class="n">images</span><span class="p">,</span><span class="n">test_data</span><span class="o">.</span><span class="n">images</span><span class="p">),</span>
           <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
          <span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">15</span><span class="p">):</span>
    <span class="n">img_original</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">test_data</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="n">i</span><span class="p">],(</span><span class="mi">28</span><span class="p">,</span><span class="mi">28</span><span class="p">))</span>
    <span class="n">axis</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img_original</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">model_1</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_data</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="n">i</span><span class="p">]),(</span><span class="mi">28</span><span class="p">,</span><span class="mi">28</span><span class="p">))</span>
    <span class="n">axis</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>


<div class="highlight"><pre><span></span>Epoch  1/20: 
[55000/55000] 98s loss =    0.0335 , val_loss =    0.0330
Epoch  2/20: 
[55000/55000] 98s loss =    0.0307 , val_loss =    0.0305
Epoch  3/20: 
[55000/55000] 99s loss =    0.0293 , val_loss =    0.0291
Epoch  4/20: 
[55000/55000] 96s loss =    0.0283 , val_loss =    0.0282
Epoch  5/20: 
[55000/55000] 96s loss =    0.0277 , val_loss =    0.0278
Epoch  6/20: 
[55000/55000] 98s loss =    0.0271 , val_loss =    0.0273

...ç•¥...

Epoch 15/20: 
[55000/55000] 99s loss =    0.0250 , val_loss =    0.0258
Epoch 16/20: 
[55000/55000] 98s loss =    0.0246 , val_loss =    0.0255
Epoch 17/20: 
[55000/55000] 99s loss =    0.0246 , val_loss =    0.0256
Epoch 18/20: 
[55000/55000] 97s loss =    0.0247 , val_loss =    0.0256
Epoch 19/20: 
[55000/55000] 98s loss =    0.0246 , val_loss =    0.0256
Epoch 20/20: 
[55000/55000] 99s loss =    0.0244 , val_loss =    0.0255
test_loss =    0.0261
</pre></div>


<p><img alt="png" src="https://raw.githubusercontent.com/GitYCC/Tensorflow_Tutorial/master/img/04_output_5_1.png"></p>
<p>ä¸Šé¢åœ–ä¸­ä¸Šæ’æ˜¯é€²å»Autoencoderä¹‹å‰çš„åœ–ç‰‡ï¼Œä¸‹æ’æ˜¯ç¶“éAutoencoderå¾Œçš„åœ–ç‰‡ï¼Œæ•ˆæœæ˜¯ä¸æ˜¯å¾ˆé©šäººï¼å¤§è‡´éƒ½æœ‰è¾¦æ³•é‚„åŸå›å»åŸåœ–ã€‚å”¯ä¸€å¯èƒ½æœ‰ç¼ºé™·çš„åœ°æ–¹æ˜¯ï¼Œé€™å€‹Autoencoderä¼¼ä¹æœƒæŠŠ5çœ‹æˆæ˜¯6ï¼Œåšå€‹Regularizationçœ‹çœ‹èƒ½ä¸èƒ½è§£æ±ºé€™å€‹å•é¡Œã€‚</p>
<div class="highlight"><pre><span></span><span class="n">model_2</span> <span class="o">=</span> <span class="n">Autoencoder</span><span class="p">(</span> <span class="n">n_features</span><span class="o">=</span><span class="mi">28</span><span class="o">*</span><span class="mi">28</span><span class="p">,</span>
                     <span class="n">learning_rate</span><span class="o">=</span> <span class="mf">0.0005</span><span class="p">,</span>
                     <span class="n">n_hidden</span><span class="o">=</span><span class="p">[</span><span class="mi">512</span><span class="p">,</span><span class="mi">32</span><span class="p">,</span><span class="mi">4</span><span class="p">],</span>
                     <span class="n">alpha</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span>
                    <span class="p">)</span>
<span class="n">model_2</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">train_data</span><span class="o">.</span><span class="n">images</span><span class="p">,</span>
           <span class="n">Y</span><span class="o">=</span><span class="n">train_data</span><span class="o">.</span><span class="n">images</span><span class="p">,</span>
           <span class="n">epochs</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
           <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">valid_data</span><span class="o">.</span><span class="n">images</span><span class="p">,</span><span class="n">valid_data</span><span class="o">.</span><span class="n">images</span><span class="p">),</span>
           <span class="n">test_data</span><span class="o">=</span><span class="p">(</span><span class="n">test_data</span><span class="o">.</span><span class="n">images</span><span class="p">,</span><span class="n">test_data</span><span class="o">.</span><span class="n">images</span><span class="p">),</span>
           <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
          <span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">15</span><span class="p">):</span>
    <span class="n">img_original</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">test_data</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="n">i</span><span class="p">],(</span><span class="mi">28</span><span class="p">,</span><span class="mi">28</span><span class="p">))</span>
    <span class="n">axis</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img_original</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">model_2</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_data</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="n">i</span><span class="p">]),(</span><span class="mi">28</span><span class="p">,</span><span class="mi">28</span><span class="p">))</span>
    <span class="n">axis</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>


<div class="highlight"><pre><span></span>Epoch  1/20: 
[55000/55000] 88s loss =    0.0332 , val_loss =    0.0328
Epoch  2/20: 
[55000/55000] 90s loss =    0.0301 , val_loss =    0.0299
Epoch  3/20: 
[55000/55000] 90s loss =    0.0288 , val_loss =    0.0287
Epoch  4/20: 
[55000/55000] 88s loss =    0.0279 , val_loss =    0.0278
Epoch  5/20: 
[55000/55000] 89s loss =    0.0274 , val_loss =    0.0275
Epoch  6/20: 
[55000/55000] 91s loss =    0.0270 , val_loss =    0.0272

...ç•¥...

Epoch 15/20: 
[55000/55000] 89s loss =    0.0247 , val_loss =    0.0255
Epoch 16/20: 
[55000/55000] 91s loss =    0.0245 , val_loss =    0.0253
Epoch 17/20: 
[55000/55000] 92s loss =    0.0244 , val_loss =    0.0253
Epoch 18/20: 
[55000/55000] 90s loss =    0.0244 , val_loss =    0.0253
Epoch 19/20: 
[55000/55000] 91s loss =    0.0244 , val_loss =    0.0254
Epoch 20/20: 
[55000/55000] 91s loss =    0.0242 , val_loss =    0.0252
test_loss =    0.0258
</pre></div>


<p><img alt="png" src="https://raw.githubusercontent.com/GitYCC/Tensorflow_Tutorial/master/img/04_output_7_1.png"></p>
<p>ä¼¼ä¹çœ‹èµ·ä¾†æ˜¯æœ‰æ•ˆæœçš„ï¼Œç¾åœ¨5æœƒè¢«å®Œæ•´é‚„åŸäº†ã€‚</p>
<p><br/></p>
<h3>å£“ç¸®ç¢¼Codeèˆ‡è¦–è¦ºåŒ–</h3>
<p>å‰›å‰›æåˆ°åœ¨Autoencoderå‰åŠæ®µæ˜¯ä¸€å€‹Encoderï¼Œæ‰€ä»¥æˆ‘å€‘å¯ä»¥åˆ©ç”¨é€™å€‹Encoderä¾†åšå£“ç¸®ï¼Œæœƒå¾—åˆ°ä¸€å€‹Codeï¼Œåœ¨ä¸Šé¢çš„é€™å€‹ä¾‹å­ï¼Œé€™å€‹Codeç¸½å…±æœ‰4å€‹å€¼ï¼Œå› ç‚ºä¸­é–“å±¤æœ‰4å€‹ç¥ç¶“å…ƒï¼Œå¯ä»¥æŠŠé€™å€‹Codeçœ‹æˆDimension Reductionçš„çµæœï¼ŒåŸæœ¬ä¸€å¼µåœ–ä»£è¡¨çš„æ˜¯28x28=784å€‹ç¶­åº¦ä¸‹çš„ä¸€å€‹é»ï¼Œç¾åœ¨ç¶“éè½‰æ›å¾Œè®Šæˆæ˜¯4å€‹ç¶­åº¦ä¸‹çš„ä¸€å€‹é»ï¼Œè€Œæˆ‘å€‘æœƒç›´è¦ºçš„èªç‚ºåŒæ¨£ä¸€ç¾¤çš„æ•¸å­—åœ–å½¢æ‡‰è©²æœƒæœ‰è¼ƒé«˜çš„ç›¸ä¼¼åº¦ï¼Œæ‰€ä»¥åœ¨4å€‹ç¶­åº¦ä¹‹ä¸‹ï¼ŒåŒæ¨£çš„æ•¸å­—åœ–ç‰‡æ‡‰è©²æœƒå½¼æ­¤é è¿‘çš„æ¯”è¼ƒè¿‘ï¼Œç”šè‡³èšæˆä¸€åœ˜ã€‚</p>
<p>æˆ‘æƒ³è¦é©—è­‰ä¸€ä¸‹é€™ä»¶äº‹ï¼Œæˆ‘å€‘éœ€è¦å…ˆåœ–åƒåŒ–ï¼Œä¸éå»å¡åœ¨ç¶­åº¦å¤ªé«˜çš„å•é¡Œï¼Œäººé¡ç„¡æ³•æƒ³åƒé«˜æ–¼3å€‹ç¶­åº¦ä»¥ä¸Šçš„ç©ºé–“ï¼Œä¹Ÿæ²’è¾¦æ³•å°‡å®ƒè¦–è¦ºåŒ–ï¼Œé€™å€‹æ™‚å€™æˆ‘å€‘éœ€è¦å†åšä¸€æ¬¡çš„Dimension Reductionï¼Œå°‡ç¶­åº¦é™åˆ°ä½æ–¼3æ‰å¯ä»¥è¦–è¦ºåŒ–ï¼Œé‚£ä¸€èˆ¬æ‰‹æ³•æ˜¯ä½¿ç”¨PCAä¾†åšé€™ä»¶äº‹ï¼Œæœ‰é—œæ–¼PCAæˆ‘ä¹‹å‰å·²ç¶“ä»‹ç´¹éï¼Œè«‹åƒè€ƒ<a href="http://www.ycc.idv.tw/YCNote/post/35">é€™ç¯‡</a>ï¼Œå¦‚æ­¤ä¸€ä¾†å°±å¯ä»¥åœ¨4å€‹ç¶­åº¦ä¸­åˆ‡ä¸€å€‹é‡è¦çš„æˆªé¢ä¾†è¦–è¦ºåŒ–é€™äº›æ•¸æ“šã€‚ä¸éè¨˜å¾—å–”ï¼4å€‹ç¶­åº¦æ‰æ˜¯çœŸæ­£å¯ä»¥è¡¨ç¤ºé€™ç¾¤è³‡æ–™ï¼ŒåšPCAåªæ˜¯ç‚ºäº†ç•«åœ–è€Œåšçš„ç²—ç•¥è½‰æ›è€Œå·²ã€‚</p>
<div class="highlight"><pre><span></span><span class="c1"># get code</span>
<span class="n">encode</span> <span class="o">=</span> <span class="n">model_2</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">test_data</span><span class="o">.</span><span class="n">images</span><span class="p">)</span>

<span class="c1"># PCA 2D visualization</span>
<span class="kn">from</span> <span class="nn">sklearn.decomposition</span> <span class="kn">import</span> <span class="n">PCA</span>
<span class="n">pca</span> <span class="o">=</span> <span class="n">PCA</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">encode</span><span class="p">)</span>
<span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">test_data</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># plot</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">X</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">Y</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>


<p><img alt="png" src="https://raw.githubusercontent.com/GitYCC/Tensorflow_Tutorial/master/img/04_output_9_0.png"></p>
<p>ä¸Šé¢æˆ‘ä»¥ä¸åŒé¡è‰²ç•¶ä½œä¸åŒçš„æ•¸å­—åœ–å½¢ï¼Œæˆ‘å€‘å¯ä»¥çœ‹åˆ°åŒæ¨£çš„æ•¸å­—åœ–å½¢æœƒå½¼æ­¤èšæˆä¸€åœ˜ï¼Œæ‰€ä»¥çš„ç¢ºåŒæ¨£çš„æ•¸å­—çš„æ—ç¾¤æœƒè¢«æ­¸é¡åˆ°å…·æœ‰ç›¸ä¼¼çš„ç‰¹æ€§ï¼Œå› æ­¤åœ¨codeè£é ­è·é›¢æ˜¯å½¼æ­¤é è¿‘çš„ï¼Œé‚„è¨˜å¾—ä¸€é–‹å§‹æˆ‘å€‘æ²’åŠ Regularizationæ™‚ã€‚ModelæœƒæŠŠ5çœ‹æˆæ˜¯6ï¼Œåœ¨é€™å¼µåœ–ä½ å°±æœƒåˆ°åŸå› ï¼Œå› ç‚º5è™Ÿè—ç¶ è‰²å’Œ6è™Ÿé»ƒè‰²é çš„å¾ˆè¿‘ï¼Œå¾ˆå®¹æ˜“èª¤åˆ¤ã€‚</p>
<p>é€™å¼µåœ–åŒæ™‚æ­éœ²äº†Autoencoderçš„ä¸€å€‹å¼·å¤§ç‰¹æ€§ï¼Œæ³¨æ„å–”!æˆ‘å€‘ä¸€é–‹å§‹Trainé€™å€‹Autoencoderçš„æ™‚å€™æ˜¯æ²’æœ‰çµ¦å®ƒçœ‹ä»»ä½•Labelsçš„ï¼Œä½†ä»–å»å¯ä»¥åœ¨å£“ç¸®è³‡è¨Šçš„åŒæ™‚æ‰¾å‡ºè¦å¾‹ï¼Œé€™å€‹è¦å¾‹å¯ä»¥æƒ³æˆæ˜¯æˆ‘å€‘äººé¡åœ¨è¾¨èªæ¯å€‹ä¸åŒæ•¸å­—çš„æ–¹æ³•ï¼Œæ‰€ä»¥Autoencoderå¯ä»¥åœ¨æ²’æœ‰Labelsçš„æƒ…æ³ä¸‹åšæ­¸ç´å’Œå­¸ç¿’ï¼Œå› æ­¤Autoencoderå¸¸å¸¸æœƒè¢«ç”¨åœ¨Unsupervised Learning (éç›£ç£å¼å­¸ç¿’)ã€‚</p>
<p>å¦å¤–ä»‹ç´¹ä¸€ç¨®ä¹Ÿæ˜¯å¾ˆæµè¡Œçš„æ–¹æ³•å«åšt-SNE (è®€ä½œ"tee-snee") ï¼Œé€™è£¡ä¸å¤šè‘—å¢¨é€™å€‹æ–¹æ³•çš„åŸç†ï¼Œä½†æ˜¯å®ƒå»æ˜¯ç›®å‰2D Visualizationæœ€æµè¡Œçš„ä½œæ³•ï¼ŒPCAåªç”¨ç·šæ€§çš„æ–¹å¼å»åšåº§æ¨™è½‰æ›ï¼Œä¹Ÿå°±æ˜¯å¾ä¸€å€‹æ©«åˆ‡é¢å»çœ‹æ•¸æ“šï¼Œé€™æ¨£ç²—ç•¥çš„è½‰æ›ä¸¦ä¸èƒ½è®“æˆ‘å€‘åœ¨è¦–è¦ºåŒ–æ™‚çœ‹å‡ºè³‡æ–™å’Œè³‡æ–™é–“å½¼æ­¤çš„è·é›¢ï¼Œå°¤å…¶æ˜¯å¾é«˜ç¶­åº¦è½‰æ›éä¾†ï¼Œç¶“å¸¸æœƒå¤±çœŸï¼Œè€Œt-SNEæ˜¯é‡å°æ•¸æ“šå’Œæ•¸æ“šé–“çš„è·é›¢å»åšè½‰æ›ï¼Œæœ€å¾Œè¢«æ”¤æˆ2ç¶­æ™‚æ­£æ˜¯é¡¯ç¤ºæ•¸æ“šé»çš„è·é›¢é—œä¿‚ï¼Œæ›´èƒ½æè¿°ç¾¤èšçš„ç¾è±¡ã€‚</p>
<p>ä¾†çœ‹çœ‹t-SNEåšèµ·ä¾†æ•ˆæœå¦‚ä½•ã€‚</p>
<div class="highlight"><pre><span></span><span class="c1"># get code</span>
<span class="n">encode</span> <span class="o">=</span> <span class="n">model_2</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">test_data</span><span class="o">.</span><span class="n">images</span><span class="p">)</span>

<span class="c1"># TSNE 2D visualization</span>
<span class="kn">from</span> <span class="nn">sklearn.manifold</span> <span class="kn">import</span> <span class="n">TSNE</span>
<span class="n">tsne</span> <span class="o">=</span> <span class="n">TSNE</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">X_embedded</span> <span class="o">=</span> <span class="n">tsne</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">encode</span><span class="p">)</span>
<span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">test_data</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># plot</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">X_embedded</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">X_embedded</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">Y</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>


<p><img alt="png" src="https://raw.githubusercontent.com/GitYCC/Tensorflow_Tutorial/master/img/04_output_11_0.png"></p>
<p><br/></p>
<h3>å»é›œè¨Š(De-noise) Autoencoder</h3>
<p>æˆ‘å€‘å·§å¦™çš„åˆ©ç”¨ä¸€ä¸‹Autoencoderï¼Œæˆ‘å€‘å°‡åŸæœ¬Autoencoderçš„å‰é¢åŠ äº†ä¸€é“äººå·¥é›œè¨Šçš„æµç¨‹ï¼Œä½†æ˜¯æœ€çµ‚åˆè¦è®“Autoencoderè©¦è‘—å»é‚„åŸå‡ºåŸä¾†æ²’æœ‰åŠ å…¥é›œè¨Šçš„è³‡è¨Šï¼Œé€™éº¼ä¸€ä¾†æˆ‘å€‘å°‡å¯ä»¥æ‰¾åˆ°ä¸€å€‹Autoencoderæ˜¯å¯ä»¥è‡ªè¡Œæ¶ˆé™¤é›œè¨Šçš„ï¼ŒæŠŠé€™å€‹Denoising AutoencoderåŠ åˆ°æ­£å¸¸Neural Networkçš„å‰é¢ï¼Œé‚£é€™å€‹Neural Networkå°±æ“æœ‰äº†æŠ‘åˆ¶é›œè¨Šçš„åŠŸç”¨ï¼Œæ‰€ä»¥å¯ä»¥ç•¶ä½œä¸€ç¨®Regularizationçš„æ–¹æ³•ã€‚</p>
<p>å…ˆå°‡åœ–ç‰‡åŠ ä¸Šé›œè¨Šã€‚</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">add_noise</span><span class="p">(</span><span class="n">ndarr</span><span class="p">):</span>
    <span class="n">noise_factor</span> <span class="o">=</span> <span class="mf">0.3</span>
    <span class="n">noisy_ndarr</span> <span class="o">=</span> <span class="n">ndarr</span> <span class="o">+</span> <span class="n">noise_factor</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                                                          <span class="n">scale</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                                                          <span class="n">size</span><span class="o">=</span><span class="n">ndarr</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">noisy_ndarr</span>

<span class="n">noisy_train_img</span> <span class="o">=</span> <span class="n">add_noise</span><span class="p">(</span><span class="n">train_data</span><span class="o">.</span><span class="n">images</span><span class="p">)</span>
<span class="n">noisy_valid_img</span> <span class="o">=</span> <span class="n">add_noise</span><span class="p">(</span><span class="n">valid_data</span><span class="o">.</span><span class="n">images</span><span class="p">)</span>
<span class="n">noisy_test_img</span> <span class="o">=</span> <span class="n">add_noise</span><span class="p">(</span><span class="n">test_data</span><span class="o">.</span><span class="n">images</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">15</span><span class="p">):</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">noisy_train_img</span><span class="p">[</span><span class="n">i</span><span class="p">],(</span><span class="mi">28</span><span class="p">,</span><span class="mi">28</span><span class="p">))</span>
    <span class="n">axis</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>


<p><img alt="png" src="https://raw.githubusercontent.com/GitYCC/Tensorflow_Tutorial/master/img/04_output_13_0.png"></p>
<p>åœ–ç‰‡ç¾åœ¨çœ‹èµ·ä¾†éå¸¸çš„é«’ã€‚</p>
<p>ç”¨é€™äº›é«’åœ–ç‰‡ç•¶ä½œInputï¼Œæ­£å¸¸åœ–ç•¶ä½œOutputçš„ç›®æ¨™ï¼Œæˆ‘å€‘å°±å¯ä»¥è‡ªç„¶è€Œç„¶çš„Trainå‡ºå¯ä»¥æ¶ˆé™¤é›œè¨Šçš„Autoencoderã€‚</p>
<div class="highlight"><pre><span></span><span class="n">denoise_model</span> <span class="o">=</span> <span class="n">Autoencoder</span><span class="p">(</span> <span class="n">n_features</span><span class="o">=</span><span class="mi">28</span><span class="o">*</span><span class="mi">28</span><span class="p">,</span>
                     <span class="n">learning_rate</span><span class="o">=</span> <span class="mf">0.0003</span><span class="p">,</span>
                     <span class="n">n_hidden</span><span class="o">=</span><span class="p">[</span><span class="mi">512</span><span class="p">,</span><span class="mi">32</span><span class="p">,</span><span class="mi">4</span><span class="p">],</span>
                     <span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                    <span class="p">)</span>
<span class="n">denoise_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">noisy_train_img</span><span class="p">,</span>
                  <span class="n">Y</span><span class="o">=</span><span class="n">train_data</span><span class="o">.</span><span class="n">images</span><span class="p">,</span>
                  <span class="n">epochs</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
                  <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">noisy_valid_img</span><span class="p">,</span><span class="n">valid_data</span><span class="o">.</span><span class="n">images</span><span class="p">),</span>
                  <span class="n">test_data</span><span class="o">=</span><span class="p">(</span><span class="n">noisy_test_img</span><span class="p">,</span><span class="n">test_data</span><span class="o">.</span><span class="n">images</span><span class="p">),</span>
                  <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
                 <span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">15</span><span class="p">):</span>
    <span class="n">img_original</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">test_data</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="n">i</span><span class="p">],(</span><span class="mi">28</span><span class="p">,</span><span class="mi">28</span><span class="p">))</span>
    <span class="n">axis</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img_original</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
    <span class="n">img_noisy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">noisy_test_img</span><span class="p">[</span><span class="n">i</span><span class="p">],(</span><span class="mi">28</span><span class="p">,</span><span class="mi">28</span><span class="p">))</span>
    <span class="n">axis</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img_noisy</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">denoise_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">noisy_test_img</span><span class="p">[</span><span class="n">i</span><span class="p">]),(</span><span class="mi">28</span><span class="p">,</span><span class="mi">28</span><span class="p">))</span>
    <span class="n">axis</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>


<div class="highlight"><pre><span></span>Epoch  1/20: 
[55000/55000] 50s loss =    0.0402 , val_loss =    0.0398
Epoch  2/20: 
[55000/55000] 50s loss =    0.0361 , val_loss =    0.0360
Epoch  3/20: 
[55000/55000] 51s loss =    0.0341 , val_loss =    0.0341
Epoch  4/20: 
[55000/55000] 51s loss =    0.0328 , val_loss =    0.0330
Epoch  5/20: 
[55000/55000] 51s loss =    0.0319 , val_loss =    0.0322
Epoch  6/20: 
[55000/55000] 51s loss =    0.0313 , val_loss =    0.0319

...ç•¥...

Epoch 15/20: 
[55000/55000] 52s loss =    0.0288 , val_loss =    0.0305
Epoch 16/20: 
[55000/55000] 51s loss =    0.0287 , val_loss =    0.0303
Epoch 17/20: 
[55000/55000] 51s loss =    0.0285 , val_loss =    0.0303
Epoch 18/20: 
[55000/55000] 51s loss =    0.0285 , val_loss =    0.0304
Epoch 19/20: 
[55000/55000] 52s loss =    0.0286 , val_loss =    0.0306
Epoch 20/20: 
[55000/55000] 52s loss =    0.0283 , val_loss =    0.0303
test_loss =    0.0307
</pre></div>


<p><img alt="png" src="https://raw.githubusercontent.com/GitYCC/Tensorflow_Tutorial/master/img/04_output_15_1.png"></p>
<p>ä¸Šé¢åœ–ç‰‡ç¬¬ä¸€æ’ç‚ºåŸåœ–ï¼Œç¬¬äºŒæ’æ˜¯åŠ å®Œé›œè¨Šå¾Œçš„çµæœï¼Œç¬¬ä¸‰æ’æ˜¯ç¶“éAutoencoderå¾Œçš„åœ–ï¼Œå‚‘å…‹çœŸçš„æ˜¯å¤ªç¥å¥‡å•¦ï¼æ‰€æœ‰çš„é›œè¨Šéƒ½è¢«æ¶ˆé™¤æ‰äº†ï¼Œç‰¹åˆ¥æ³¨æ„ï¼Œé€™è£¡æˆ‘çš„Regularizationä¸‹çš„ç‰¹åˆ¥é‡ï¼ŒåŸå› æ˜¯é›œè¨Šå¢å¤šäº†ï¼Œä¹Ÿæ›´å®¹æ˜“Overfittingï¼Œæ‰€ä»¥è¦ä¸‹æ›´å¤šçš„Regularizationæ‰èƒ½æŠ‘åˆ¶å®ƒã€‚</p>


        
    </div>
        <!-- /Content --> 

        <!-- Footer -->
        <div class="footer gradient-2">
            <div class="container footer-container ">
                <div class="row">
                    <div class="col-xs-4 col-sm-3 col-md-3 col-lg-3">
                        <div class="footer-title">Sitemap</div>
                        <ul class="list-unstyled">
                            <li><a href="./archives.html">Archives</a></li>
                            <li><a href="./tags.html">Tags</a></li>
                            <li><a href="YCNote/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">Atom Feed</a></li>
                        </ul>
                    </div>
                    <div class="col-xs-4 col-sm-3 col-md-3 col-lg-3">
                        <div class="footer-title">Contact Me</div>
                        <ul class="list-unstyled">
                            <li><a href="./about-me.html" target="_blank">About Me</a></li>
                            <li><a href="https://github.com/GitYCC" target="_blank">Github</a></li>
                            <li><a href="mailto:ycc.tw.email@gmail.com" target="_blank">Email</a></li>
                        </ul>
                    </div>
                    <div class="col-xs-4 col-sm-3 col-md-3 col-lg-3">
                    </div> 
                    <div class="col-xs-12 col-sm-3 col-md-3 col-lg-3">
                        <p class="pull-right text-right">
                            <small><em>Proudly powered by <a href="http://docs.getpelican.com/" target="_blank">pelican</a></em></small><br/>
                            <small><em>Theme and code by <a href="https://github.com/molivier" target="_blank">molivier</a></em></small><br/>
                            <small>&copy; YC Note 2018</small>
                        </p>
                    </div>
                </div>
            </div>
        </div>
        <!-- /Footer -->
    </body>
</html>