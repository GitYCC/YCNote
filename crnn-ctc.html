<!DOCTYPE html>
<html class="no-js" lang="en">
<head>

    <!--- basic page needs
    ================================================== -->
    <meta charset="utf-8">
    <title>OCRï¼šCRNN+CTCé–‹æºåŠ è©³ç´°è§£æ - YC Note</title>
    <meta name="description" content="Pytorch CRNN+CTC é–‹æºå›‰ï¼ä¸¦ä¸”åœ¨é€™ç¯‡ä¸­æœƒä»”ç´°ä»‹ç´¹ CRNN çš„æ¶æ§‹ï¼Œä»¥åŠ CTC çš„æ¶æ§‹ã€è¨“ç·´çš„åƒæ•¸å„ªåŒ–å’Œå…¶ä¸‰ç¨® Inference æ–¹æ³•ï¼ˆgreedy decode, beam search decode, prefix beam search decodeï¼‰">
    <meta name="author" content="YC Chen">

    <meta property="og:type" content="article" />
    <meta property="og:title" content="OCRï¼šCRNN+CTCé–‹æºåŠ è©³ç´°è§£æ" />
    <meta property="og:description" content="Pytorch CRNN+CTC é–‹æºå›‰ï¼ä¸¦ä¸”åœ¨é€™ç¯‡ä¸­æœƒä»”ç´°ä»‹ç´¹ CRNN çš„æ¶æ§‹ï¼Œä»¥åŠ CTC çš„æ¶æ§‹ã€è¨“ç·´çš„åƒæ•¸å„ªåŒ–å’Œå…¶ä¸‰ç¨® Inference æ–¹æ³•ï¼ˆgreedy decode, beam search decode, prefix beam search decodeï¼‰" />
    <meta property="og:image" content="https://www.ycc.idv.tw/images/book-glass-read-study-learn-text-bible-see.jpg" />
    <meta property="og:url" content="https://www.ycc.idv.tw/crnn-ctc.html" />
    <meta property="og:site_name" content="YC Note" />

    <script type="application/ld+json">
        {
          "@context": "https://schema.org",
          "@type": "BreadcrumbList",
          "itemListElement": [{
            "@type": "ListItem",
            "position": 1,
            "name": "AI.ML",
            "item": "https://www.ycc.idv.tw/category/aiml.html"
          },{
            "@type": "ListItem",
            "position": 2,
            "name": "OCRï¼šCRNN+CTCé–‹æºåŠ è©³ç´°è§£æ",
            "item": "https://www.ycc.idv.tw/crnn-ctc.html"
          }]
        }
    </script>
    <script type="application/ld+json">
        {
          "@context" : "http://schema.org",
          "@type" : "Article",
          "name" : "OCRï¼šCRNN+CTCé–‹æºåŠ è©³ç´°è§£æ - YC Note",
          "author" : {
            "@type" : "Person",
            "name" : "YC Chen"
          },
          "datePublished" : "2020-10-12",
          "image" : "https://www.ycc.idv.tw/images/book-glass-read-study-learn-text-bible-see.jpg",
          "articleSection" : "AI.ML",
          "articleBody" : "Pytorch CRNN+CTC é–‹æºå›‰ï¼ä¸¦ä¸”åœ¨é€™ç¯‡ä¸­æœƒä»”ç´°ä»‹ç´¹ CRNN çš„æ¶æ§‹ï¼Œä»¥åŠ CTC çš„æ¶æ§‹ã€è¨“ç·´çš„åƒæ•¸å„ªåŒ–å’Œå…¶ä¸‰ç¨® Inference æ–¹æ³•ï¼ˆgreedy decode, beam search decode, prefix beam search decodeï¼‰",
          "url" : "https://www.ycc.idv.tw/crnn-ctc.html",
          "publisher" : {
            "@type" : "Organization",
            "name" : "YC Note",
            "logo" : {
                "@type" : "ImageObject",
                "url": "https://www.ycc.idv.tw/theme/images/favicon.png"
            }
          },
          "headline" : "OCRï¼šCRNN+CTCé–‹æºåŠ è©³ç´°è§£æ"
        }
    </script>

    <!-- mobile specific metas
    ================================================== -->
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- CSS
    ================================================== -->
    <link rel="stylesheet" href="https://www.ycc.idv.tw/theme/css/base.css">
    <link rel="stylesheet" href="https://www.ycc.idv.tw/theme/css/vendor.css">
    <link rel="stylesheet" href="https://www.ycc.idv.tw/theme/css/main.css">
    <!-- <link rel="stylesheet" href="https://www.ycc.idv.tw/theme/css/all.min.css"> -->
    <link rel='stylesheet' id='font-awesome-css'  href='https://mk0athemesdemon3j7s5.kinstacdn.com/wp-content/themes/astrid/fonts/font-awesome.min.css?ver=5.2.4' type='text/css' media='all' />

    <!-- script
    ================================================== -->
    <script src="https://www.ycc.idv.tw/theme/js/modernizr.js"></script>

    <!-- favicons
    ================================================== -->
    <link rel="icon" type="image/png" sizes="32x32" href="https://www.ycc.idv.tw/theme/images/favicon.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://www.ycc.idv.tw/theme/images/favicon.png">

    <!-- Google Analytics
    ================================================== -->
    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-68393177-2', 'auto');
        ga('send', 'pageview');
    </script>

    <script type="text/x-mathjax-config"> 
        MathJax.Hub.Config({ 
            "HTML-CSS": { scale: 90, linebreaks: { automatic: true } }, 
            SVG: { linebreaks: { automatic:true } } 
            });
    </script>

</head>

<body class="ss-bg-white">

    <!-- preloader
    ================================================== -->
    <div id="preloader">
        <div id="loader" class="dots-fade">
            <div></div>
            <div></div>
            <div></div>
        </div>
    </div>

    <div id="top" class="s-wrap site-wrapper">

        <!-- site header
        ================================================== -->
        <header class="s-header header">

            <div class="header__top">
                <div class="header__logo">
                    <a class="site-logo" href="https://www.ycc.idv.tw/">
                        <img src="https://www.ycc.idv.tw/theme/images/favicon.png" alt="Homepage">
                    </a>
                </div>

                <!-- toggles -->
                <a href="#0" class="header__menu-toggle"><span>Menu</span></a>

            </div>

            <nav class="header__nav-wrap">

                <ul class="header__nav">
                    <li><a href="https://www.ycc.idv.tw/" title="">Home</a></li>
                    <li class="has-children">
                        <a href="#0" title="">Categories</a>
                        <ul class="sub-menu">
                            <li><a href="https://www.ycc.idv.tw/category/aiml.html">AI.ML</a></li>
                            <li><a href="https://www.ycc.idv.tw/category/coding.html">Coding</a></li>
                            <li><a href="https://www.ycc.idv.tw/category/life.html">Life</a></li>
                            <li><a href="https://www.ycc.idv.tw/category/reading.html">Reading</a></li>
                        </ul>
                    </li>
                    <li class="has-children">
                        <a href="#0" title="">Tags</a>
                        <ul class="sub-menu">
                            <li><a href="https://www.ycc.idv.tw/tag/ai-ji.html">åŸƒåŠ</a></li>
                            <li><a href="https://www.ycc.idv.tw/tag/cv.html">CV</a></li>
                            <li><a href="https://www.ycc.idv.tw/tag/ji-qi-xue-xi-ji-fa.html">æ©Ÿå™¨å­¸ç¿’æŠ€æ³•</a></li>
                            <li><a href="https://www.ycc.idv.tw/tag/ji-qi-xue-xi-ji-shi.html">æ©Ÿå™¨å­¸ç¿’åŸºçŸ³</a></li>
                            <li><a href="https://www.ycc.idv.tw/tag/ji-ta.html">å‰ä»–</a></li>
                            <li><a href="https://www.ycc.idv.tw/tag/papers.html">Papers</a></li>
                            <li><a href="https://www.ycc.idv.tw/tag/pou-xi-shen-du-xue-xi.html">å‰–ææ·±åº¦å­¸ç¿’</a></li>
                            <li><a href="https://www.ycc.idv.tw/tag/pythonwan-shu-ju.html">Pythonç©æ•¸æ“š</a></li>
                            <li><a href="https://www.ycc.idv.tw/tag/ruan-ti-she-ji.html">è»Ÿé«”è¨­è¨ˆ</a></li>
                            <li><a href="https://www.ycc.idv.tw/tag/tensorflow.html">Tensorflow</a></li>
                            <li><a href="https://www.ycc.idv.tw/tag/you-ji.html">éŠè¨˜</a></li>
                        </ul>
                    </li>
                    <li></li>
                    <li><a href="https://www.ycc.idv.tw/#about" title="">About</a></li>
                </ul> <!-- end header__nav -->

                <ul class="header__social">
                    <li class="ss-facebook">
                        <a href="https://www.facebook.com/yc.note/" target="_blank">
                            <span class="screen-reader-text">Facebook</span>
                        </a>
                    </li>
                    <li class="ss-github">
                        <a href="https://github.com/GitYCC" target="_blank">
                            <span class="screen-reader-text">Github</span>
                        </a>
                    </li>
                    <li class="ss-linkedin">
                        <a href="https://www.linkedin.com/in/yi-chang-chen-aba1b6114/" target="_blank">
                            <span class="screen-reader-text">Linkedin</span>
                        </a>
                    </li>
                    <li class="ss-email">
                        <a href="mailto:ycc.tw.email@gmail.com" target="_blank">
                            <span class="screen-reader-text">Email</span>
                        </a>
                    </li>

                </ul>

            </nav> <!-- end header__nav-wrap -->

        </header> <!-- end s-header -->


        <!-- site content
        ================================================== -->
        <div class="s-content content">
            <main class="row content__page">

                <article class="column large-full entry format-standard">

                    <div class="media-wrap entry__media">
                        <div class="entry__post-thumb">
                            <img src="https://www.ycc.idv.tw/images/book-glass-read-study-learn-text-bible-see.jpg" 
                                 srcset="https://www.ycc.idv.tw/images/book-glass-read-study-learn-text-bible-see.jpg 2000w, 
                                 https://www.ycc.idv.tw/images/book-glass-read-study-learn-text-bible-see.jpg 1000w, 
                                 https://www.ycc.idv.tw/images/book-glass-read-study-learn-text-bible-see.jpg 500w" sizes="(max-width: 2000px) 100vw, 2000px" alt="">
                        </div>
                    </div>

                    <div class="content__page-header entry__header">
                        <h1 class="display-1 entry__title">
                        OCRï¼šCRNN+CTCé–‹æºåŠ è©³ç´°è§£æ
                        </h1>
                        <ul class="entry__header-meta">
                            <li class="author"><i class="fa fa-user"></i> YC Chen</a></li>
                            <li class="date"><i class="fa fa-calendar"></i> 2020-10-12</li>
                            <li class="cat-links">
                                <i class="fa fa-archive"></i> <a href="https://www.ycc.idv.tw/category/aiml.html">AI.ML</a>
                            </li>
                            <li>
                                <i class="fa fa-tags"></i> 
<a href="https://www.ycc.idv.tw/tag/cv.html">CV</a>                            </li>
                        </ul>
                    </div> <!-- end entry__header -->

                    <div class="entry__content">
                        <div style="background-color: rgba(0, 0, 0, 0.0470588);padding: 20px;margin-bottom:  50px;">
                            Pytorch CRNN+CTC é–‹æºå›‰ï¼ä¸¦ä¸”åœ¨é€™ç¯‡ä¸­æœƒä»”ç´°ä»‹ç´¹ CRNN çš„æ¶æ§‹ï¼Œä»¥åŠ CTC çš„æ¶æ§‹ã€è¨“ç·´çš„åƒæ•¸å„ªåŒ–å’Œå…¶ä¸‰ç¨® Inference æ–¹æ³•ï¼ˆgreedy decode, beam search decode, prefix beam search decodeï¼‰
                        </div>

                        <p>å ´æ™¯æ–‡å­—è¾¨è­˜ OCR (Optical Character Recognition) æ‡‰ç”¨å ´æ™¯éå¸¸å¤šï¼Œä¾‹å¦‚ï¼šEvernoteæä¾›çš„åç‰‡è¾¨è­˜ã€è«¸å¤šéŠ€è¡Œå…§éƒ¨ä½¿ç”¨çš„å­˜æ‘ºå½±åƒè¾¨è­˜ã€æ–°å‹åœè»Šå ´æä¾›çš„è»Šç‰Œè¾¨è­˜ç³»çµ±ã€è­‰ä»¶è­˜åˆ¥å·¥å…·ã€æ—…éŠæ¥­æœƒç”¨åˆ°è­·ç…§è­˜åˆ¥ï¼Œä¸å‹æšèˆ‰ï¼å‡¡æ˜¯æƒ³è¦å°‡ç”Ÿæ´»å ´æ™¯ä¸­çš„æ–‡å­—è—‰ç”±æ©Ÿå™¨å»è®€å–çš„éƒ½æ˜¯OCRçš„ç¯„ç–‡ï¼Œå®ƒæœƒç‚ºä¼æ¥­çœä¸‹è¨±å¤šäººå·¥åˆ¤è®€çš„äººåŠ›æˆæœ¬ã€‚</p>
<p>åœ¨å ´æ™¯æ–‡å­—è¾¨è­˜ä¸­ç›¸ç•¶ç¶“å…¸çš„æ¨¡å‹å°±æ˜¯ <a href="http://arxiv.org/abs/1507.05717">CRNN+CTC</a>ï¼ŒGithub ä¸Šä¹Ÿæœ‰è¨±å¤šç›¸é—œçš„ Repo.ï¼Œä½† YC ç™¼ç¾æ²’æœ‰ä¸€å€‹å°‡é€™å€‹æ¨¡å‹å¯«çš„å¤ å¥½ã€å¤ å®¹æ˜“ä¿®æ”¹çš„ pytorch é–‹æºç¨‹å¼ç¢¼ï¼Œæ‰€ä»¥ YC æ±ºå®šè‡ªå·±å¹¹ä¸€å€‹ä¸¦ä¸”å°‡å®ƒé–‹æºï¼Œç›®å‰æ­é…è³‡æ–™é›† Synth90k å·²ç¶“å¯ä»¥åœ¨è‹±æ–‡è¾¨è­˜ä¸Šåšåˆ° 93.9 % çš„ Sequence Accuracyï¼Œæ­¡è¿å¤§å®¶ä¾†å˜—è©¦ä½¿ç”¨ï¼</p>
<h3>é–‹æºï¼špytorchç‰ˆæœ¬çš„CRNN+CTC</h3>
<p><a href="https://github.com/GitYCC/crnn-pytorch">GitYCC/crnn-pytorch</a></p>
<p>ğŸ‘†ğŸ¼ğŸ‘†ğŸ¼ğŸ‘†ğŸ¼ğŸ‘†ğŸ¼ğŸ‘†ğŸ¼</p>
<p>éº»ç…©å¤§å®¶ä¸åçµ¦äºˆæ˜Ÿæ˜Ÿ â­ï¸ï¼Œä¸¦ä¸”åˆ†äº«çµ¦æ›´å¤šäººçŸ¥é“ï¼</p>
<p><img alt="reading" src="http://www.ycc.idv.tw/media/CV/170_READING_62745.jpg"></p>
<p><img alt="showtime" src="http://www.ycc.idv.tw/media/CV/178_Showtime_70541.jpg"></p>
<p><img alt="novel" src="http://www.ycc.idv.tw/media/CV/78_Novel_52433.jpg"></p>
<h3>ç¶²è·¯æ¶æ§‹</h3>
<p>CRNN+CTC çµæ§‹æºæ–¼è«–æ–‡<a href="http://arxiv.org/abs/1507.05717">An End-to-End Trainable Neural Network for Image-based Sequence Recognition and Its Application to Scene Text Recognition (2015), Baoguang Shi et al.</a>ï¼Œå…¶ç¶²è·¯æ¶æ§‹å…¶å¯¦ä¸¦ä¸è¤‡é›œï¼Œè¬›ç™½äº†å°±æ˜¯ CNN çš„ Backbone å†æ­é… Bi-directional RNNï¼Œæœ€å¾Œå°æ¯å€‹æ™‚é–“é»ä½œSoftmaxåˆ†é¡å•é¡Œï¼Œä½†æ˜¯åœ¨è¡¡é‡è¼¸å‡ºæ™‚å‰‡æ˜¯éœ€è¦ç¶œè§€æ¯å€‹æ™‚é–“é»çš„ CTC Lossã€‚</p>
<p><img alt="crnn_structure" src="http://www.ycc.idv.tw/media/CV/crnn_structure.png"></p>
<p><img alt="crnn_structure_detail" src="http://www.ycc.idv.tw/media/CV/crnn_structure_detail.png"></p>
<p>é¦–å…ˆï¼Œå°‡åœ–ç‰‡è½‰æˆç°éšä¸¦ä¸”ä¼¸ç¸®è‡³é«˜åº¦32ï¼Œé€šéå¤šå±¤çš„Conv2Dã€MaxPoolå’ŒBatchNormalizationæŠ½å–åœ–ç‰‡ç›¸é—œçš„ç‰¹å¾µã€‚</p>
<div class="highlight"><pre><span class="k">assert</span> <span class="n">img_height</span> <span class="o">%</span> <span class="mi">16</span> <span class="o">==</span> <span class="mi">0</span>
<span class="k">assert</span> <span class="n">img_width</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">==</span> <span class="mi">0</span>

<span class="n">channels</span> <span class="o">=</span> <span class="p">[</span><span class="n">img_channel</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">512</span><span class="p">]</span>
<span class="n">kernel_sizes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
<span class="n">strides</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
<span class="n">paddings</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

<span class="n">cnn</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">conv_relu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">batch_norm</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="c"># shape of input: (batch, input_channel, height, width)</span>
    <span class="n">input_channel</span> <span class="o">=</span> <span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">output_channel</span> <span class="o">=</span> <span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">cnn</span><span class="o">.</span><span class="n">add_module</span><span class="p">(</span>
        <span class="n">f</span><span class="s">&#39;conv{i}&#39;</span><span class="p">,</span>
        <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">input_channel</span><span class="p">,</span> <span class="n">output_channel</span><span class="p">,</span> <span class="n">kernel_sizes</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">strides</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">paddings</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">batch_norm</span><span class="p">:</span>
        <span class="n">cnn</span><span class="o">.</span><span class="n">add_module</span><span class="p">(</span><span class="n">f</span><span class="s">&#39;batchnorm{i}&#39;</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="n">output_channel</span><span class="p">))</span>

    <span class="n">relu</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">LeakyReLU</span><span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="k">if</span> <span class="n">leaky_relu</span> <span class="k">else</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">cnn</span><span class="o">.</span><span class="n">add_module</span><span class="p">(</span><span class="n">f</span><span class="s">&#39;relu{i}&#39;</span><span class="p">,</span> <span class="n">relu</span><span class="p">)</span>

<span class="c"># size of image: (channel, height, width) = (img_channel, img_height, img_width)</span>
<span class="n">conv_relu</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">cnn</span><span class="o">.</span><span class="n">add_module</span><span class="p">(</span><span class="s">&#39;pooling0&#39;</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">MaxPool2d</span><span class="p">(</span><span class="n">kernel_size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
<span class="c"># (64, img_height // 2, img_width // 2)</span>

<span class="n">conv_relu</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">cnn</span><span class="o">.</span><span class="n">add_module</span><span class="p">(</span><span class="s">&#39;pooling1&#39;</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">MaxPool2d</span><span class="p">(</span><span class="n">kernel_size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
<span class="c"># (128, img_height // 4, img_width // 4)</span>

<span class="n">conv_relu</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">conv_relu</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">cnn</span><span class="o">.</span><span class="n">add_module</span><span class="p">(</span>
    <span class="s">&#39;pooling2&#39;</span><span class="p">,</span>
    <span class="n">nn</span><span class="o">.</span><span class="n">MaxPool2d</span><span class="p">(</span><span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="p">)</span>  <span class="c"># (256, img_height // 8, img_width // 4)</span>

<span class="n">conv_relu</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">batch_norm</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">conv_relu</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">batch_norm</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">cnn</span><span class="o">.</span><span class="n">add_module</span><span class="p">(</span>
    <span class="s">&#39;pooling3&#39;</span><span class="p">,</span>
    <span class="n">nn</span><span class="o">.</span><span class="n">MaxPool2d</span><span class="p">(</span><span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="p">)</span>  <span class="c"># (512, img_height // 16, img_width // 4)</span>

<span class="n">conv_relu</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>  <span class="c"># (512, img_height // 16 - 1, img_width // 4 - 1)</span>
</pre></div>


<p>æ¥ä¸‹ä¾†è—‰ç”±ä¸€å€‹ DenseLayer å»å°‡åœ–ç‰‡è½‰æˆç¶­åº¦ç‚º <code>map_to_seq_hidden</code> çš„åºåˆ—ï¼Œé€™æ¨£å°±å¯ä»¥æ¥çºŒçš„ä½¿ç”¨ RNN ä¾†èƒå–åºåˆ—çš„ç‰¹å¾µã€‚</p>
<div class="highlight"><pre><span class="bp">self</span><span class="o">.</span><span class="n">map_to_seq</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">output_channel</span> <span class="o">*</span> <span class="n">output_height</span><span class="p">,</span> <span class="n">map_to_seq_hidden</span><span class="p">)</span>
</pre></div>


<p>é€™é‚Šç‰¹åˆ¥æ³¨æ„ä¸€ä¸‹ï¼Œç•¶ä½ ç¶“é CNN Backbone ä¹‹å¾Œçš„ç¶­åº¦æ˜¯ï¼š<code>(batch, channel, new_height, new_width)</code> ï¼Œä½†æ˜¯ä½ å¸Œæœ›é€²RNNå‰çš„ç¶­åº¦æ˜¯ï¼š<code>(seq_len, batch, map_to_seq_hidden)</code> ï¼Œæ‰€ä»¥éœ€è¦å°‡ <code>channel, new_height</code> æ”¤å¹³å†é DenseLayerï¼Œå¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre><span class="n">conv</span> <span class="o">=</span> <span class="n">conv</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">channel</span> <span class="o">*</span> <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span>
<span class="n">conv</span> <span class="o">=</span> <span class="n">conv</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c"># (width, batch, feature)</span>
<span class="n">seq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_to_seq</span><span class="p">(</span><span class="n">conv</span><span class="p">)</span>
</pre></div>


<p><img alt="map_to_seq" src="http://www.ycc.idv.tw/media/CV/map_to_seq.png"></p>
<p>æœ€å¾Œå†éå…©å±¤ Bi-directional LSTM èƒå–åºåˆ—ç›¸é—œçš„ç‰¹å¾µï¼Œä¸¦ä¸”é DenseLayer ä¾†å°‡ç¶­åº¦è½‰æˆèˆ‡åˆ†é¡çš„æ•¸é‡ç›¸åŒï¼Œå†é Softmax å°±å¤§åŠŸå‘Šæˆï¼æ³¨æ„ï¼šåˆ†é¡çš„é¡åˆ¥æ˜¯æ‰€æœ‰è¦é æ¸¬çš„å­—å…ƒå†åŠ ä¸Š blank Îµ ï¼Œä¸€èˆ¬æˆ‘å€‘æœƒè®“ blank Îµ åœ¨Onehot Encoding æ™‚æ”¾åœ¨ index=0 çš„ä½ç½®ã€‚</p>
<p><img alt="" src="http://www.ycc.idv.tw/media/CV/biLSTM.png"></p>
<p>è©³ç´°æ¨¡å‹æ¶æ§‹è«‹è©³è¦‹ï¼š<a href="https://github.com/GitYCC/crnn-pytorch/blob/master/src/model.py">src/model.py</a></p>
<h3>CTC (Connectionist Temporal Classification)</h3>
<p>RNNs èˆ‡å…¶ä»–å‚³çµ±æ–¹æ³•ç›¸æ¯”ï¼Œå¦‚ï¼šHMMs (Hidden Markov Model) å’Œ CRFs (Conditional Random Field) æœ‰ä»¥ä¸‹å„ªå‹¢ï¼š</p>
<ul>
<li>RNNs ç„¡é ˆå¤šé¤˜çš„å…ˆé©—å‡è¨­</li>
<li>RNNs æä¾›äº†ç›¸ç•¶å¼·å¤§ä¸”ä¸€èˆ¬åŒ–çš„æ©Ÿåˆ¶å»æè¿°æ™‚é–“åºåˆ—</li>
</ul>
<p>ä½†æ˜¯ RNNs åªèƒ½è¨“ç·´åœ¨å·²ç¶“åˆ†é…å¥½çš„åºåˆ—ä¸Šï¼Œæ‰€ä»¥ç•¶ä½ åƒ…æœ‰ Sequence Label æ˜¯ä¸å¤ çš„ï¼Œé‚„éœ€è¦çŸ¥é“é€™äº› Label è¦æ€éº¼è¢«<strong>åˆ†é…</strong>ã€‚èˆ‰å€‹ä¾‹å­ï¼šå¦‚æœä»Šå¤©ä½ è¦è¾¨è­˜çš„åœ–ç‰‡åŒ…å« <code>"CAT"</code> é€™å€‹è©ï¼Œä½ æƒ³è¦ä½¿ç”¨ RNN é€²è¡Œè¾¨è­˜ï¼Œè€Œé€™å€‹ RNN é•·åº¦å‡è¨­ç‚º 7ï¼Œç‚ºäº†è¦èƒ½è¨“ç·´ RNN æˆ‘å€‘éœ€è¦çµ¦å®ƒ Groud Trueï¼Œæ­¤æ™‚ä½ å°±éœ€è¦å°‡ <code>"CAT"</code> é€™ 3 å€‹å­—<strong>åˆ†é…</strong>åˆ° 7 æ ¼ä¸­ï¼Œä½†æ˜¯é€™æ¨£çš„æ¨™æ³¨æ˜¯è²»å·¥çš„ã€ä¸åˆ‡å¯¦éš›çš„ï¼Œ<strong>æˆ‘å€‘å¸Œæœ›å¯ä»¥ç›´æ¥è¨“ç·´åœ¨æ²’æœ‰åˆ†é…å‰çš„ Sequence Label ä¸Š</strong>ã€‚</p>
<p>CTC è¨­è¨ˆäº†ä¸€å€‹æ©Ÿåˆ¶è®“æˆ‘å€‘å¯ä»¥åšåˆ°é€™ä»¶äº‹ï¼š</p>
<ol>
<li>åœ¨åŸæœ¬è¦é æ¸¬çš„å­—å…ƒä¸­å¤šåŠ å…¥äº† blank Îµ </li>
<li>é€éæ˜ å°„æ©Ÿåˆ¶ <span class="math">\(B\)</span> å°‡ RNN çš„è¼¸å‡ºè½‰åŒ–æˆ Sequence Prediction</li>
<li>æ˜ å°„æ©Ÿåˆ¶ <span class="math">\(B\)</span>ï¼šåˆä½µç›¸é„°çš„å­—å…ƒä¸¦ä¸”é™¤å» blank Îµ </li>
</ol>
<p><img alt="ctc mapping" src="http://www.ycc.idv.tw/media/CV/ctc_mapping.png"></p>
<p>æœ‰äº†é€™å€‹æ˜ å°„æ©Ÿåˆ¶ <span class="math">\(B\)</span> æˆ‘å€‘å°±å¯ä»¥ä¸éœ€è¦äº‹å…ˆåˆ†é… Sequence Label ä¹Ÿèƒ½è¨“ç·´ç¶²è·¯ï¼Œä½†æ˜¯è¦æ³¨æ„ï¼šèƒ½æ˜ å°„åˆ°ä¸€çµ„ Sequence Label çš„å¯èƒ½æ€§æ˜¯æœ‰å¾ˆå¤šçµ„åˆçš„ï¼Œä¾‹å¦‚ï¼š<code>"hee-l-lloo"</code> å’Œ <code>"hheel-lloo"</code> éƒ½æœƒæ˜ å°„åˆ° <code>"hello"</code>ï¼Œæ‰€ä»¥è¦ç‰¹åˆ¥å»è¨­è¨ˆå®ƒçš„ Loss è®“å…¶å¯ä»¥è€ƒæ…®å„ç¨®å¯èƒ½æ€§ï¼Œé€™æœƒåœ¨ä¸‹ä¸€ç¯€ä¸­ä»”ç´°é—¡è¿°ã€‚</p>
<h3>CTC Loss: Forward-Backward Algorithm</h3>
<p>æ¥ä¸‹ä¾†é€™ä¸€å€‹éƒ¨åˆ†å°‡æœƒæ˜¯æœ¬ç¯‡æœ€é›£ç†è§£çš„éƒ¨åˆ†ï¼Œè€Œä¸”ä¹Ÿæœ€ç‚ºæ•¸å­¸ï¼Œæ‰€ä»¥åœ¨é™·é€²å»æ•¸å­¸æ¼©æ¸¦ä¹‹å‰ï¼Œæˆ‘å€‘å…ˆä¾†æ¦‚å¿µæ€§çš„äº†è§£ CTC Loss ç©¶ç«Ÿæ˜¯åšäº†ä»€éº¼ã€‚ç°¡è¨€ä¹‹ï¼Œ<strong>æˆ‘å€‘éœ€è¦è®“ CTC Loss é™ä½çš„åŒæ™‚ï¼Œç­‰åŒæ–¼åšåˆ°æå‡ç”¢ç”Ÿ Groud True Sequence Label çš„æ©Ÿç‡ï¼Œè€Œåœ¨æ˜ å°„å‡½æ•¸ <span class="math">\(B\)</span> çš„ä½œç”¨ä¸‹ç”¢ç”Ÿé€™å€‹ Groud True Sequence Label æœƒæœ‰å¤šç¨®ä¾†æºçµ„åˆï¼Œé€™äº›çµ„åˆéƒ½å¿…é ˆè¢«è€ƒæ…®é€²å»ï¼Œç„¶å¾Œæˆ‘å€‘æœ‰äº† CTC Loss èˆ‡åƒæ•¸çš„é—œä¿‚å¼å°±å¯ä»¥ä½¿ç”¨æ¢¯åº¦ä¸‹é™é€²è¡Œå„ªåŒ–ã€‚</strong></p>
<p>æ‰€ä»¥æˆ‘å€‘éœ€è¦çª®èˆ‰æ‰€æœ‰å¯èƒ½çš„çµ„åˆæ‰èƒ½æ­£ç¢ºçš„å°‡ç”¢ç”Ÿ Groud True Sequence Label çš„æ©Ÿç‡ç®—å‡ºä¾†ï¼Œæˆ‘å€‘å°±ä¾†è©¦è‘—ç¾…åˆ—ã€‚å‡è¨­æˆ‘å€‘çš„ Sequence Label æ˜¯ <code>"CAT"</code> ï¼Œè¦‹åœ–ä¸€ï¼Œæ‰€ä»¥æˆ‘å€‘çš„ <span class="math">\(\ell\)</span> ç‚º <code>"CAT"</code>ï¼Œç‚ºäº†æŠŠ blank Îµ åˆ—å…¥è€ƒæ…®ï¼Œæˆ‘å€‘è¨­è¨ˆäº† <span class="math">\(\ell'\)</span>ï¼Œå…¶é•·åº¦é—œä¿‚ç‚º <span class="math">\(|\ell'|=2|\ell|+1\)</span> ã€‚åƒç…§æ˜ å°„å‡½æ•¸çš„è¦å‰‡ï¼Œåªæœ‰åœ–ä¸­å…©å€‹ç´…é»æ˜¯å¯èƒ½çš„å‡ºç™¼é»ã€å…©å€‹è—é»æ˜¯å¯èƒ½çš„çµæŸé»ï¼Œå› æ­¤æˆ‘å€‘éœ€è¦ç¾…åˆ—å¾å‡ºç™¼é»åˆ°çµæŸé»å¯èƒ½çš„è·¯å¾‘ <span class="math">\(\pi\)</span>ï¼Œé€™äº›è·¯å¾‘éƒ½å¯ä»¥åœ¨ç¶“éæ˜ å°„å‡½æ•¸ <span class="math">\(B\)</span> å¾Œç”¢ç”Ÿ Sequence Label <code>"CAT"</code> ã€‚</p>
<p><img alt="" src="http://www.ycc.idv.tw/media/CV/IMG_ctc_example_01.png"></p>
<p><center><small>
  åœ–ä¸€
</small></center><br></p>
<p>åŠ ç¸½æ‰€æœ‰å¯èƒ½é€é <span class="math">\(B\)</span> æ˜ å°„è‡³ Groud True Sequence Label <span class="math">\(\ell\)</span> çš„æ¢ä»¶æ©Ÿç‡ï¼š
</p>
<div class="math">$$
p(\ell|y)=\sum_{Ï€:B(Ï€)=\ell}p(Ï€|y)\ \text{ â†ªï¸ã€1ã€‘}
$$</div>
<p>
å…¶ä¸­ï¼š
</p>
<div class="math">$$
p(Ï€|y)=\prod_{t=1}^{T}y^{t}_{Ï€_t}\ \text{ â†ªï¸ã€2ã€‘}
$$</div>
<p>
<span class="math">\(y^{t}_{Ï€_t}\)</span> è¡¨ç¤ºåœ¨æ™‚é–“ <span class="math">\(t\)</span> Label ç‚º <span class="math">\(Ï€_t\)</span> çš„æ©Ÿç‡ã€‚</p>
<p>è€Œæˆ‘å€‘çš„ç›®æ¨™å°±æ˜¯æƒ³è¦æœ€å¤§åŒ– <span class="math">\(p(\ell|y)\)</span> ï¼Œå– <span class="math">\(ln\)</span> åœ¨åŠ ä¸Šè² è™Ÿï¼Œå°±æœƒè®Šæ›æˆç‚ºæœ€å°åŒ–å•é¡Œï¼š
</p>
<div class="math">$$
min_{y}\ -ln[p(\ell|y)]\ \text{ â†ªï¸ã€3ã€‘}
$$</div>
<p>
åªè¦ç®—å…¶å¾®åˆ†ï¼Œå°±å¯ä»¥ä½¿ç”¨æ¢¯åº¦ä¸‹é™çš„æ–¹æ³•é€²è¡Œå„ªåŒ–ï¼š
</p>
<div class="math">$$
\frac{\partial}{\partial y}\{ -ln[p(\ell|y)]\}=\frac{-1}{p(\ell|y)}\frac{\partial p(\ell|y)}{\partial y}\ \text{ â†ªï¸ã€4ã€‘}
$$</div>
<p>
æ‰€ä»¥åªè¦è§£æ±ºå…©ä»¶äº‹ï¼šå¦‚ä½•è¨ˆç®— <span class="math">\(p(\ell|y)\)</span> å’Œ <span class="math">\(\frac{\partial p(\ell|y)}{\partial y}\)</span> ï¼Œå°±å¯ä»¥å„ªåŒ–åƒæ•¸äº†ï¼</p>
<hr>
<p>ä½†æ˜¯çª®èˆ‰å„ç¨®å¯èƒ½è·¯å¾‘æœ‰é€™éº¼ç°¡å–®å—ï¼Ÿå¹¸å¥½æˆ‘å€‘æœ‰ <a href="https://zh.wikipedia.org/zh-tw/åŠ¨æ€è§„åˆ’">Dynamic Programming</a> ï¼Œé€™è£¡å€Ÿé¡è§£ HMM å„ªåŒ–å•é¡Œæœƒä½¿ç”¨çš„ Forward-Backward Algorithm ä¾†è§£æ±ºé€™å€‹å•é¡Œã€‚ <a href="https://zh.wikipedia.org/zh-tw/åŠ¨æ€è§„åˆ’">Dynamic Programming</a> æ˜¯ä¸€ç¨®éè¿´çš„æ¼”ç®—æ³•ï¼Œåªè¦æœ‰åˆå§‹å€¼å’Œéè¿´å¼å°±å¯ä»¥ä¸€è·¯ç®—ä¸‹å»ã€‚é‹ç”¨åœ¨é€™å€‹å•é¡Œä¸Šï¼Œæˆ‘å€‘åªéœ€è¦æ‰¾åˆ°åœ¨ <span class="math">\(y_t\)</span> å’Œ <span class="math">\(y_{t-1}\)</span> çš„æ©Ÿç‡ç´¯åŠ éè¿´é—œä¿‚ï¼Œä»¥åŠ <span class="math">\(y_1\)</span> æ™‚åˆ»çš„æ©Ÿç‡åˆ†å¸ƒï¼Œå°±å¯ä»¥ä¸€è·¯ç®—åˆ°æœ€å¾Œä¸€å€‹æ™‚åˆ»é» <span class="math">\(T\)</span> çš„æ©Ÿç‡ç´¯ç©ã€‚</p>
<p>é¦–å…ˆï¼Œæˆ‘å€‘å…ˆä¾†å®šç¾©ã€ŒForward Algorithmã€çš„ <span class="math">\(\alpha\)</span> ï¼š
</p>
<div class="math">$$
\alpha_t(s)\equiv\sum_{Ï€:B(Ï€_{1:t})=\ell_{1:s}}\prod_{t'=1}^{t}y^{t'}_{Ï€_{t'}}\ \text{ â†ªï¸ã€5ã€‘}
$$</div>
<p>
<span class="math">\(\alpha_t(s)\)</span> è¡¨ç¤ºå¾å¯èƒ½çš„èµ·å§‹é»ç´¯ç©åˆ° <span class="math">\(t\)</span> æ™‚åˆ»ä¸” Label <span class="math">\(\ell'=s\)</span>  é‚£é»çš„ç¸½æ©Ÿç‡ï¼Œå¯ä»¥å¾å¼å­çš„å³å¼çœ‹å‡ºï¼ŒåŠ ç¸½æ‰€æœ‰èƒ½å°‡ <span class="math">\(Ï€_{1:t}\)</span> (åœ–ä¸€ä¸­çš„è¡¡æ¬„) æ˜ å°„åˆ° <span class="math">\(\ell_{1:s}\)</span> (åœ–ä¸€ä¸­çš„ç¸±æ¬„) çš„è·¯å¾‘ <span class="math">\(\pi\)</span> ï¼Œä¸¦ä¸”å°‡é€™è·¯å¾‘ <span class="math">\(\pi\)</span> ä¸Šçš„å„é»æ©Ÿç‡ç›¸ä¹˜ (å› ç‚ºäº’ç‚ºç¨ç«‹äº‹ä»¶)ã€‚</p>
<p>å†åƒç…§åœ–ä¸€å’Œã€1ã€‘å¼ï¼Œæˆ‘å€‘çŸ¥é“ <span class="math">\(p(\ell|y)\)</span> å¯ä»¥ç”¨ <span class="math">\(\alpha_t(s)\)</span> è¡¨ç¤ºï¼š
</p>
<div class="math">$$
p(\ell|y)=\alpha_T(|\ell'|)+\alpha_T(|\ell'|-1)\ \text{ â†ªï¸ã€6ã€‘}
$$</div>
<p>
å³å¼çš„å…©é …ä»£è¡¨çµæŸçš„å…©å€‹è—é»ã€‚</p>
<p>å¾ã€5ã€‘å¼æˆ‘å€‘å¯ä»¥å¾—åˆ° <span class="math">\(t=1\)</span> çš„åˆå§‹å€¼ï¼Œå› ç‚ºåªæœ‰å…©å€‹ç´…é»æ˜¯å¯èƒ½çš„è·¯å¾‘ï¼Œæ‰€ä»¥å¾—åˆ°ï¼š
</p>
<div class="math">$$
\begin{cases}
    \alpha_1(1)=y_\epsilon^1 \\
    \alpha_1(2)=y_{\ell_1}^1 \\
    \alpha_1(s)=0,\ \forall s&gt; 2
\end{cases}\ \text{ â†ªï¸ã€7ã€‘}
$$</div>
<p>
å¾ã€5ã€‘å¼æˆ‘å€‘ä¹Ÿå¯ä»¥å¾—åˆ°éè¿´å¼ï¼š
</p>
<div class="math">$$
\alpha_t(s)=[\sum_{Ï€:B(Ï€_{1:t-1})=\ell_{1:s}}\prod_{t'=1}^{t}y^{t'}_{Ï€_{t'}}]y^{t}_{l'_{s}}=[\sum_{s'\in connected\ to\ (t,s)}\alpha_{t-1}(s')]y^{t}_{l'_{s}}\ \text{ â†ªï¸ã€8ã€‘}
$$</div>
<p>
é€£æ¥åˆ° <span class="math">\((t,s)\)</span> å¯åˆ†ç‚ºä¸‰ç¨®è·¯å¾‘æƒ…æ³ï¼Œå¦‚ä¸‹åœ–ï¼š</p>
<p><img alt="" src="http://www.ycc.idv.tw/media/CV/IMG_ctc_example_02.png"></p>
<p><center><small>
  åœ–äºŒï¼šForward Algorithmå¯èƒ½è·¯å¾‘
</small></center><br></p>
<p>æ‰€ä»¥æˆ‘å€‘å¯ä»¥æŠŠã€8ã€‘éè¿´å¼å¯«å¾—æ›´åŠ æ¸…æ¥šï¼š
</p>
<div class="math">$$
\alpha_t(s)= 
\begin{cases}
    [\alpha_{t-1}(s)+\alpha_{t-1}(s-1)]y_{l'_s}^t&amp; \text{if } l'_s=\epsilon\text{ or }l'_{s-2}=l'_s\\
    [\alpha_{t-1}(s)+\alpha_{t-1}(s-1)+\alpha_{t-1}(s-2)]y_{l'_s}^t   &amp; \text{otherwise}
\end{cases}\ \text{ â†ªï¸ã€9ã€‘}
$$</div>
<p>
å–„ç”¨ã€9ã€‘å¼éè¿´å¼å’Œã€7ã€‘å¼åˆå§‹å€¼ï¼Œä½ å°±å¯ä»¥æ±‚å¾—åœ–ä¸€ä¸­æ‰€æœ‰æ ¼å­çš„ <span class="math">\(\alpha_t(s)\)</span> å€¼ï¼Œå†è—‰ç”±ã€6ã€‘å¼å°±å¯ä»¥å¾—åˆ° <span class="math">\(p(\ell|y)\)</span>ã€‚</p>
<hr>
<p>æˆ‘å€‘é †åˆ©çš„è§£æ±ºäº†ã€4ã€‘å¼ä¸­çš„ <span class="math">\(p(\ell|y)\)</span>ï¼Œé‚£æ¥ä¸‹ä¾†åªå‰©ä¸‹ <span class="math">\(\frac{\partial p(\ell|y)}{\partial y}\)</span>ï¼Œç‚ºäº†ç®—é€™ä¸€é …æˆ‘å€‘é‚„éœ€è¦ã€ŒBackward Algorithmã€ï¼Œã€ŒBackward Algorithmã€çš„ <span class="math">\(\beta\)</span> å®šç¾©å¦‚ä¸‹ï¼š 
</p>
<div class="math">$$
\beta_t(s)\equiv\sum_{Ï€:B(Ï€_{t:T})=\ell_{s:|\ell|}}\prod_{t'=t}^{T}y^{t'}_{Ï€_{t'}}\ \text{ â†ªï¸ã€10ã€‘}
$$</div>
<p>
å¾ã€10ã€‘å¼æˆ‘å€‘å¯ä»¥å¾—åˆ° <span class="math">\(t=T\)</span> çš„åˆå§‹å€¼ï¼Œå› ç‚ºåªæœ‰å…©å€‹è—é»æ˜¯å¯èƒ½çš„è·¯å¾‘ï¼Œæ‰€ä»¥å¾—åˆ°ï¼š
</p>
<div class="math">$$
\begin{cases}
    \beta_T(|\ell'|)=y_\epsilon^T \\
    \beta_T(|\ell'|-1)=y_{\ell_{|\ell|}}^T \\
    \beta_T(s)=0,\ \forall s&lt; |\ell'|-1
\end{cases}\ \text{ â†ªï¸ã€11ã€‘}
$$</div>
<p>
å¾ã€10ã€‘å¼æˆ‘å€‘ä¹Ÿå¯ä»¥å¾—åˆ°éè¿´å¼ï¼š
</p>
<div class="math">$$
\beta_t(s)=y^{t}_{l'_{s}}[\sum_{Ï€:B(Ï€_{t:T})=\ell_{s:|\ell|}}\prod_{t'=t+1}^{T}y^{t'}_{Ï€_{t'}}]=y^{t}_{l'_{s}}[\sum_{s'\in connected\ from\ (t,s)}\beta_{t+1}(s')]\ \text{ â†ªï¸ã€12ã€‘}
$$</div>
<p>
å¾ <span class="math">\((t,s)\)</span> é€£æ¥çš„æƒ…æ³ä¸€æ¨£ä¹Ÿå¯åˆ†ç‚ºä¸‰ç¨®æƒ…æ³ï¼Œå¦‚ä¸‹åœ–ï¼š</p>
<p><img alt="" src="http://www.ycc.idv.tw/media/CV/IMG_ctc_example_03.png"></p>
<p><center><small>
  åœ–ä¸‰ï¼šBackward Algorithmå¯èƒ½è·¯å¾‘
</small></center><br></p>
<p>æ‰€ä»¥æˆ‘å€‘å¯ä»¥æŠŠã€12ã€‘éè¿´å¼å¯«å¾—æ›´åŠ æ¸…æ¥šï¼š
</p>
<div class="math">$$
\beta_t(s)= 
\begin{cases}
    [\beta_{t+1}(s)+\beta_{t+1}(s+1)]y_{l'_s}^t&amp; \text{if } l'_s=\epsilon\text{ or }l'_{s+2}=l'_s\\
    [\beta_{t+1}(s)+\beta_{t+1}(s+1)+\beta_{t+1}(s+2)]y_{l'_s}^t   &amp; \text{otherwise}
\end{cases}\ \text{ â†ªï¸ã€13ã€‘}
$$</div>
<hr>
<p>ç•¶æˆ‘å€‘æŠŠ Forward Algorithm å’Œ Backward Algorithm åˆåœ¨ä¸€èµ·å°±æœƒå¾—åˆ°ä¸€å€‹å¥½ç”¨çš„å…¬å¼ï¼Œç¶œã€5ã€‘å’Œã€10ã€‘å¼ï¼š
</p>
<div class="math">$$
\alpha_t(s)\beta_t(s)=\sum_{Ï€:B(Ï€)=\ell\ \&amp;\ \pi_t=\ell'_s}\ y_{\ell'_s}^t\prod_{t'=1}^{T}y^{t'}_{Ï€_{t'}}\ \text{ â†ªï¸ã€14ã€‘}
$$</div>
<p>
å†è€ƒæ…®ã€2ã€‘å¼
</p>
<div class="math">$$
\Rightarrow \frac{\alpha_t(s)\beta_t(s)}{y_{\ell'_s}^t}=\sum_{Ï€:B(Ï€)=\ell\ \&amp;\ \pi_t=\ell'_s}\ \prod_{t'=1}^{T}y^{t'}_{Ï€_{t'}}ï¼\sum_{Ï€:B(Ï€)=\ell\ \&amp;\ \pi_t=\ell'_s}p(Ï€|y)\ \text{ â†ªï¸ã€15ã€‘}
$$</div>
<p>
å†è€ƒæ…®ã€1ã€‘å¼
</p>
<div class="math">$$
p(\ell|y)=\sum_{s=1}^{|\ell'|}\sum_{Ï€:B(Ï€)=\ell\ \&amp;\ \pi_t=\ell'_s}p(Ï€|y)=\sum_{s=1}^{|\ell'|}\frac{\alpha_t(s)\beta_t(s)}{y_{\ell'_s}^t}\ \text{ â†ªï¸ã€16ã€‘}
$$</div>
<p>
ã€16ã€‘å¼æä¾›äº†å¦å¤–ä¸€å€‹æ±‚ <span class="math">\(p(\ell|y)\)</span> çš„æ–¹æ³•ï¼Œè€Œä¸”é€™å€‹ç®—æ³•å¯ä»¥åœ¨ä»»æ„æ™‚é–“é» <span class="math">\(t\)</span> ä½œè¨ˆç®—ï¼Œæ›´æ£’çš„æ˜¯å®ƒå¯ä»¥è®“æˆ‘å€‘å¾ˆæ–¹ä¾¿çš„æ±‚å¾— <span class="math">\(\frac{\partial p(\ell|y)}{\partial y}\)</span> ï¼š
</p>
<div class="math">$$
\frac{\partial p(\ell|x)}{\partial y_k^t}=\frac{\partial}{\partial y_k^t}[\sum_{s=1}^{|\ell'|}\frac{\alpha_t(s)\beta_t(s)}{y_{\ell'_s}^t}]\ \text{ â†ªï¸ã€17ã€‘}
$$</div>
<p>
å› ç‚ºå¾®åˆ†çš„é—œä¿‚ï¼Œä¸Šå¼åŠ ç¸½ä¸­èˆ‡ <span class="math">\(y_k^t\)</span> ç„¡é—œçš„é …éƒ½æœƒåŒ–ç‚ºé›¶ï¼Œå¯ä»¥é€²ä¸€æ­¥æ”¹å¯«ï¼š
</p>
<div class="math">$$
=\frac{\partial}{\partial y_k^t}[\sum_{s\in \{\ell'_s=k\}}\frac{\alpha_t(s)\beta_t(s)}{y_{\ell'_s}^t}]
$$</div>
<div class="math">$$
=\frac{\partial}{\partial y_k^t}[\sum_{s\in \{\ell'_s=k\}}\frac{(\cdots)y_{l'_s}^t\times y_{l'_s}^t(\cdots)}{y_{l'_s}^t}]
$$</div>
<div class="math">$$
=\sum_{s\in \{\ell'_s=k\}}\frac{(\cdots)y_{l'_s}^t\times y_{l'_s}^t(\cdots)}{[y_{l'_s}^{t}]^2}
$$</div>
<div class="math">$$
\Rightarrow \frac{\partial p(\ell|x)}{\partial y_k^t}=\frac{1}{[y_{l'_s}^{t}]^2}\sum_{s\in \{\ell'_s=k\}}\alpha_t(s)\beta_t(s)\ \text{ â†ªï¸ã€18ã€‘}
$$</div>
<p>å› æ­¤ç¶œã€6ã€‘å’Œã€18ã€‘æˆ‘å€‘å°±å¯ä»¥è§£ã€4ã€‘å¼ï¼Œç„¶å¾Œå°±å¯ä»¥å°ç¶²è·¯åšåå‘å‚³æ’­å„ªåŒ–åƒæ•¸äº†ï¼</p>
<h3>Inference of CTC</h3>
<p>åœ¨ <a href="https://github.com/GitYCC/crnn-pytorch">GitYCC/crnn-pytorch</a> ä¸­æˆ‘æœ‰å¯¦ä½œäº†<a href="https://github.com/GitYCC/crnn-pytorch/blob/master/src/ctc_decoder.py">ä¸‰ç¨® CTC çš„ Inference æ–¹æ³•</a>ï¼Œåˆ†åˆ¥ç‚º <code>greedy_decode</code>ã€<code>beam_search_decode</code> å’Œ <code>prefix_beam_decode</code>ï¼Œç²¾ç¢ºåº¦ä¾åºè¶Šä¾†è¶Šæº–ç¢ºï¼Œä½†æ˜¯éš¨è‘—ç²¾ç¢ºåº¦æé«˜æ‰€èŠ±çš„ Inference æ™‚é–“ä¹Ÿå°±è¶Šé•·ã€‚</p>
<p>äº‹å¯¦ä¸Šï¼Œé€™ä¸‰ç¨®æ–¹å¼éƒ½ä¸æ˜¯æœ€ä½³è§£ï¼ŒçœŸæ­£çš„æœ€ä½³è§£å¾—æšèˆ‰å‡ºæ‰€æœ‰å¯èƒ½çš„ Sequence Label çµ„åˆå†å–æœ€å¤§æ©Ÿç‡çš„é‚£ä¸€å€‹ï¼Œå®ƒå¿…é ˆè¦è¡¡é‡ <span class="math">\((C+1)^T\)</span> æ¢è·¯å¾‘ä¸”æ¯æ¢è·¯å¾‘éƒ½éœ€è¦è¦åš <span class="math">\(T\)</span> æ¬¡çš„ä¹˜æ³•ï¼Œæ‰€ä»¥æ™‚é–“è¤‡é›œåº¦ç‚º <span class="math">\(O(T\times (C+1)^T)\)</span>ï¼Œé€™å€‹è¨ˆç®—é‡å¤§åˆ°ä¸åˆ‡å¯¦éš›ï¼Œå‡è¨­è‹±æ–‡å­—æ¯ <span class="math">\(C=26\)</span> ï¼Œç„¶å¾Œ <span class="math">\(T\)</span> å‡è¨­ç‚º <span class="math">\(20\)</span>ï¼Œæ™‚é–“è¤‡é›œåº¦æœƒé”åˆ° <span class="math">\(8.4e\text{+}29\)</span>ã€‚</p>
<p>æ‰€ä»¥æ¥ä¸‹ä¾†æˆ‘æœƒé€ä¸€ä»‹ç´¹ä¸‰ç¨®å¸¸è¦‹çš„è¿‘ä¼¼æ–¹æ³•ã€‚</p>
<h4>Greedy Decode</h4>
<div class="math">$$
\ell^*\approx B(\pi^*)\ ;\ \pi^*= \{argmax_{s}\ y^{t}_{s}\ \text{ for t=1..T}\}
$$</div>
<p>é€™æ˜¯æœ€ heuristic çš„æ–¹æ³•ï¼Œç›´æ¥æ‰¾åœ¨æ¯å€‹æ™‚é–“é» <span class="math">\(t\)</span> æœ€å¤§çš„ <span class="math">\(s\)</span> ç•¶ä½œè·¯å¾‘ <span class="math">\(\pi^*\)</span> å†éæ˜ å°„å‡½æ•¸ <span class="math">\(B\)</span>ã€‚é€™å€‹æ–¹æ³•é›–ç„¶ç°¡å–®ï¼Œä½†åœ¨å¤§éƒ¨åˆ†æƒ…æ³ä¸‹æœƒæ˜¯æ­£ç¢ºçš„ã€‚åœ¨æœ€ä½³è§£æ™‚æˆ‘å€‘å¸Œæœ›çš„æ˜¯åœ¨éå®Œæ˜ å°„å‡½æ•¸ <span class="math">\(B\)</span> ä¹‹å¾Œå¾—åˆ°æœ€å¤§å¯èƒ½çš„è·¯å¾‘ <span class="math">\(\ell^*\)</span> ï¼Œæ‰€ä»¥éœ€è¦è€ƒæ…®æ‰€æœ‰å¯èƒ½çš„è·¯å¾‘ä¸¦å°‡å…¶æ©Ÿç‡åŠ ç¸½æ‰èƒ½å¾—åˆ°æœ€ä½³è§£ï¼Œä½†æ˜¯  Greedy Decode å‰‡æ˜¯åªè€ƒæ…®äº†æœ€é«˜æ©Ÿç‡çš„ä¸€æ¢è·¯å¾‘ã€‚</p>
<p><img alt="" src="http://www.ycc.idv.tw/media/CV/IMG_ctc_greed_decode.png"></p>
<p><center><small>
  åœ–å››ï¼šGreedy Decode
</small></center><br></p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">greedy_decode</span><span class="p">(</span><span class="n">emission_log_prob</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">emission_log_prob</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">_reconstruct</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="n">blank</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">labels</span>
</pre></div>


<h4>Beam Search Decode</h4>
<p>æ—¢ç„¶åªé¸ä¸€æ¢æ©Ÿç‡æœ€å¤§çš„è·¯å¾‘ä¸é‚£éº¼ç²¾ç¢ºï¼Œé‚£éº¼æˆ‘å°±é¸æœ€å¤§çš„å‰ <span class="math">\(k\)</span> æ¢è·¯å¾‘å†å°‡å…¶æ©Ÿç‡ç›¸åŠ ï¼Œé€™å€‹å°±æ˜¯ Beam Search çš„è¿‘ä¼¼æ–¹æ³•ã€‚ç‚ºäº†é”åˆ°é€™å€‹ç›®çš„ï¼Œæˆ‘å€‘åœ¨æ¯ä¸€å€‹æ™‚é–“é» <span class="math">\(t\)</span> éƒ½æœƒä¿ç•™å‰ <span class="math">\(k\)</span> æ¢ç´¯ç©ç›¸ä¹˜æ©Ÿç‡æœ€å¤§çš„å¯èƒ½è·¯å¾‘ï¼Œå¦‚ä¸‹åœ–æ‰€ç¤ºã€‚</p>
<p><img alt="" src="http://www.ycc.idv.tw/media/CV/IMG_ctc_beam_search.png"></p>
<p><center><small>
  åœ–äº”ï¼šBeam Search Decode (beam size = 2)
</small></center><br></p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">beam_search_decode</span><span class="p">(</span><span class="n">emission_log_prob</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">beam_size</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;beam_size&#39;</span><span class="p">]</span>
    <span class="n">emission_threshold</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;emission_threshold&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">DEFAULT_EMISSION_THRESHOLD</span><span class="p">))</span>

    <span class="n">length</span><span class="p">,</span> <span class="n">class_count</span> <span class="o">=</span> <span class="n">emission_log_prob</span><span class="o">.</span><span class="n">shape</span>

    <span class="n">beams</span> <span class="o">=</span> <span class="p">[([],</span> <span class="mi">0</span><span class="p">)]</span>  <span class="c"># (prefix, accumulated_log_prob)</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">length</span><span class="p">):</span>
        <span class="n">new_beams</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">accumulated_log_prob</span> <span class="ow">in</span> <span class="n">beams</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">class_count</span><span class="p">):</span>
                <span class="n">log_prob</span> <span class="o">=</span> <span class="n">emission_log_prob</span><span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">log_prob</span> <span class="o">&lt;</span> <span class="n">emission_threshold</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">new_prefix</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="p">[</span><span class="n">c</span><span class="p">]</span>
                <span class="c"># log(p1 * p2) = log_p1 + log_p2</span>
                <span class="n">new_accu_log_prob</span> <span class="o">=</span> <span class="n">accumulated_log_prob</span> <span class="o">+</span> <span class="n">log_prob</span>
                <span class="n">new_beams</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">new_prefix</span><span class="p">,</span> <span class="n">new_accu_log_prob</span><span class="p">))</span>

        <span class="c"># sorted by accumulated_log_prob</span>
        <span class="n">new_beams</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">beams</span> <span class="o">=</span> <span class="n">new_beams</span><span class="p">[:</span><span class="n">beam_size</span><span class="p">]</span>

    <span class="c"># sum up beams to produce labels</span>
    <span class="n">total_accu_log_prob</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">accu_log_prob</span> <span class="ow">in</span> <span class="n">beams</span><span class="p">:</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">_reconstruct</span><span class="p">(</span><span class="n">prefix</span><span class="p">))</span>
        <span class="c"># log(p1 + p2) = logsumexp([log_p1, log_p2])</span>
        <span class="n">total_accu_log_prob</span><span class="p">[</span><span class="n">labels</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">logsumexp</span><span class="p">([</span><span class="n">accu_log_prob</span><span class="p">,</span> <span class="n">total_accu_log_prob</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">NINF</span><span class="p">)])</span>

    <span class="n">labels_beams</span> <span class="o">=</span> <span class="p">[(</span><span class="nb">list</span><span class="p">(</span><span class="n">labels</span><span class="p">),</span> <span class="n">accu_log_prob</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">labels</span><span class="p">,</span> <span class="n">accu_log_prob</span> <span class="ow">in</span> <span class="n">total_accu_log_prob</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
    <span class="n">labels_beams</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">labels_beams</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">labels</span>
</pre></div>


<p>å…¶ä¸­ç”¨åˆ° <code>logsumexp</code> çš„ç”¨æ„æ˜¯å› ç‚ºæˆ‘å€‘æ“ä½œåœ¨ Log Probability ä¸Šé¢ï¼Œé›–ç„¶æ©Ÿç‡ç›¸ä¹˜å³æ˜¯ Log Probability ç›¸åŠ ï¼Œå¾ˆæ–¹ä¾¿æ“ä½œã€‚ä½†æ˜¯å¦‚æœç¢°åˆ°éœ€è¦æ©Ÿç‡ç›¸åŠ æ™‚ï¼Œå°±éœ€è¦å…ˆå– <span class="math">\(exp\)</span> é‚„åŸå¾Œå†ç›¸åŠ å†å– <span class="math">\(log\)</span> ï¼Œå³ï¼š<span class="math">\(log(p1 + p2) = logsumexp([log(p1), log(p2)])\)</span>ã€‚</p>
<h4>Prefix Beam Search Decode</h4>
<p>æˆ‘å€‘å¯ä»¥å†é€²ä¸€æ­¥è®“å®ƒæ›´ç²¾ç¢ºä¸€é»ï¼Œå‰›å‰›çš„ Beam Search æ˜¯åœ¨æ˜ å°„å‡½æ•¸ <span class="math">\(B\)</span> ä¹‹å‰æ‰¾ <span class="math">\(k\)</span> æ¢è·¯å¾‘ï¼ŒPrefix Beam Search æ›´é€²ä¸€æ­¥æ‹¿å‰ <span class="math">\(k\)</span> æ¢ç¶“éæ˜ å°„å‡½æ•¸ <span class="math">\(B\)</span> å¾Œçš„ Prefix ç•¶ä½œè©•ä¼°çš„æ–¹å¼ ï¼Œå¦‚æ­¤æœƒæ›´æ¥è¿‘æˆ‘å€‘æƒ³è¦æ‰¾åˆ°æ˜ å°„å¾Œçš„æœ€é«˜æ©Ÿç‡çš„ Sequenceã€‚</p>
<p>åœ¨ Prefix çš„ä¸–ç•Œè£¡ä¸å­˜åœ¨ blank Îµï¼Œä½†æ˜¯ blank Îµ å»æ˜¯æœƒå½±éŸ¿ Prefixï¼Œä¾‹å¦‚ï¼š<code>"A-A"</code> æ˜ å°„å®Œæœƒæ˜¯ <code>"AA"</code>ï¼Œä½†æ˜¯ <code>"AA"</code> æ˜ å°„å®Œå‰‡æœƒæ˜¯ <code>"A"</code> ï¼Œæ‰€ä»¥åœ¨ Prefix Beam Search å­˜åœ¨ <code>ProbabilityWithBlank</code> å’Œ <code>ProbabilityNoBlank</code> å…©ç¨®ç´¯ç©æ©Ÿç‡ï¼Œé€™å…©ç¨®æƒ…æ³åˆ†åˆ¥æ˜¯çµå°¾æœ‰ blank çš„<strong>ç´¯ç©</strong>æ©Ÿç‡å’Œçµå°¾æ²’æœ‰ blank çš„<strong>ç´¯ç©</strong>æ©Ÿç‡ï¼Œç‰¹åˆ¥æ³¨æ„ï¼š<strong>ç´¯ç©</strong>æ©Ÿç‡ä»£è¡¨å¾é–‹å§‹åˆ°ç›®å‰çš„ç¸½æ©Ÿç‡ã€‚</p>
<p>æœ‰äº†é€™å€‹æ¦‚å¿µï¼Œæˆ‘å€‘ä¾†çœ‹æœƒé‡åˆ°ä»€éº¼æ¨£çš„ç‹€æ³ï¼Œä¸¦ä¸”åœ¨æ¯å€‹ç‹€æ³ä¸‹æˆ‘å€‘è¦æ€éº¼å»è¨ˆç®— <code>ProbabilityWithBlank</code> å’Œ <code>ProbabilityNoBlank</code> ï¼Œä»¥ä¸‹ç¬¦è™Ÿ <code>*</code> ä»£è¡¨ä¸Šä¸€æ™‚åˆ»çš„ prefixï¼Œ<code>E</code> ä»£è¡¨ä¸Šä¸€æ™‚åˆ» prefix çš„æœ€å¾Œä¸€å€‹å­—å…ƒï¼Œ<code>Îµ</code> ä»£è¡¨ blankï¼Œä»¥ä¸‹çš„æƒ…æ³çš†æ˜¯åœ¨è€ƒæ…®æ–°å­—å…ƒé€²ä¾†è¦æ€éº¼å»ç´¯åŠ  <code>ProbabilityWithBlank</code> å’Œ <code>ProbabilityNoBlank</code> ï¼š</p>
<p><img alt="" src="http://www.ycc.idv.tw/media/CV/prefix_beam_search_formula.png"></p>
<p>ç‰¹åˆ¥æ³¨æ„ï¼Œä»¥ä¸Šåˆå§‹åŒ–æ˜¯é‡åˆ°æ–°çš„å­—å…ƒå°±å‡è¨­å…¶å¾Œæœƒä¸å¸¶ blankã€‚</p>
<p>ç•¶ç„¶æ¯æ¬¡è€ƒæ…®ä¸€å€‹æ–°çš„æ™‚é–“é»ï¼Œæˆ‘å€‘éƒ½éœ€è¦å»ç´¯åŠ å¯èƒ½æœƒç”¢ç”Ÿé€™å€‹ Prefix çš„å„ç¨®æƒ…æ³ï¼Œå› æ­¤åœ¨ä»¥ä¸‹çš„ç¨‹å¼ç¢¼ä¸­ï¼Œæˆ‘å€‘çš„ <code>ProbabilityWithBlank</code> å’Œ <code>ProbabilityNoBlank</code> æ˜¯æœƒè¿­ä»£ç´¯åŠ çš„ã€‚ç•¶ç´¯ç©å®Œé€™å€‹æ™‚é–“é»çš„æ‰€æœ‰ Prefix æ©Ÿç‡å¾Œï¼Œæˆ‘å€‘æœƒå–å‰ <span class="math">\(k\)</span> å¤§æ©Ÿç‡çš„ Prefix ç•™ä¸‹ä¾†ç¹¼çºŒå¾€ä¸‹ä¸€å€‹æ™‚é–“é»ç´¯åŠ ï¼Œæ­¤æ™‚è¦ç”¨ <code>ProbabilityWithBlank</code> å’Œ <code>ProbabilityNoBlank</code> çš„åˆä¾†ç•¶ä½œæ’åºçš„ä¾æ“šã€‚</p>
<p><img alt="" src="http://www.ycc.idv.tw/media/CV/IMG_ctc_prefix_beam_search.png"></p>
<p><center><small>
  åœ–å…­ï¼šPrefix Beam Search Decode (beam size = 2)
</small></center><br></p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">prefix_beam_decode</span><span class="p">(</span><span class="n">emission_log_prob</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">beam_size</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;beam_size&#39;</span><span class="p">]</span>
    <span class="n">emission_threshold</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;emission_threshold&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">DEFAULT_EMISSION_THRESHOLD</span><span class="p">))</span>

    <span class="n">length</span><span class="p">,</span> <span class="n">class_count</span> <span class="o">=</span> <span class="n">emission_log_prob</span><span class="o">.</span><span class="n">shape</span>

    <span class="n">beams</span> <span class="o">=</span> <span class="p">[(</span><span class="nb">tuple</span><span class="p">(),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">NINF</span><span class="p">))]</span>  <span class="c"># (prefix, (blank_log_prob, non_blank_log_prob))</span>
    <span class="c"># initial of beams: (empty_str, (log(1.0), log(0.0)))</span>

    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">length</span><span class="p">):</span>
        <span class="n">new_beams_dict</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="p">(</span><span class="n">NINF</span><span class="p">,</span> <span class="n">NINF</span><span class="p">))</span>  <span class="c"># log(0.0) = NINF</span>

        <span class="k">for</span> <span class="n">prefix</span><span class="p">,</span> <span class="p">(</span><span class="n">lp_b</span><span class="p">,</span> <span class="n">lp_nb</span><span class="p">)</span> <span class="ow">in</span> <span class="n">beams</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">class_count</span><span class="p">):</span>
                <span class="n">log_prob</span> <span class="o">=</span> <span class="n">emission_log_prob</span><span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">log_prob</span> <span class="o">&lt;</span> <span class="n">emission_threshold</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">end_t</span> <span class="o">=</span> <span class="n">prefix</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">prefix</span> <span class="k">else</span> <span class="bp">None</span>

                <span class="c"># if new_prefix == prefix</span>
                <span class="n">new_lp_b</span><span class="p">,</span> <span class="n">new_lp_nb</span> <span class="o">=</span> <span class="n">new_beams_dict</span><span class="p">[</span><span class="n">prefix</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="n">blank</span><span class="p">:</span>
                    <span class="n">new_beams_dict</span><span class="p">[</span><span class="n">prefix</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">logsumexp</span><span class="p">([</span><span class="n">new_lp_b</span><span class="p">,</span> <span class="n">lp_b</span> <span class="o">+</span> <span class="n">log_prob</span><span class="p">,</span> <span class="n">lp_nb</span> <span class="o">+</span> <span class="n">log_prob</span><span class="p">]),</span>
                        <span class="n">new_lp_nb</span>
                    <span class="p">)</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="n">end_t</span><span class="p">:</span>
                    <span class="n">new_beams_dict</span><span class="p">[</span><span class="n">prefix</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">new_lp_b</span><span class="p">,</span>
                        <span class="n">logsumexp</span><span class="p">([</span><span class="n">new_lp_nb</span><span class="p">,</span> <span class="n">lp_nb</span> <span class="o">+</span> <span class="n">log_prob</span><span class="p">])</span>
                    <span class="p">)</span>

                <span class="c"># if new_prefix == prefix + (c,)</span>
                <span class="n">new_prefix</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="p">(</span><span class="n">c</span><span class="p">,)</span>
                <span class="n">new_lp_b</span><span class="p">,</span> <span class="n">new_lp_nb</span> <span class="o">=</span> <span class="n">new_beams_dict</span><span class="p">[</span><span class="n">new_prefix</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">c</span> <span class="o">!=</span> <span class="n">end_t</span><span class="p">:</span>
                    <span class="n">new_beams_dict</span><span class="p">[</span><span class="n">new_prefix</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">new_lp_b</span><span class="p">,</span>
                        <span class="n">logsumexp</span><span class="p">([</span><span class="n">new_lp_nb</span><span class="p">,</span> <span class="n">lp_b</span> <span class="o">+</span> <span class="n">log_prob</span><span class="p">,</span> <span class="n">lp_nb</span> <span class="o">+</span> <span class="n">log_prob</span><span class="p">])</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">new_beams_dict</span><span class="p">[</span><span class="n">new_prefix</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">new_lp_b</span><span class="p">,</span>
                        <span class="n">logsumexp</span><span class="p">([</span><span class="n">new_lp_nb</span><span class="p">,</span> <span class="n">lp_b</span> <span class="o">+</span> <span class="n">log_prob</span><span class="p">])</span>
                    <span class="p">)</span>

        <span class="c"># sorted by log(blank_prob + non_blank_prob)</span>
        <span class="n">beams</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">new_beams_dict</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">logsumexp</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">beams</span> <span class="o">=</span> <span class="n">beams</span><span class="p">[:</span><span class="n">beam_size</span><span class="p">]</span>

    <span class="n">labels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">beams</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">labels</span>
</pre></div>


<h3>çµèª</h3>
<p>æˆ‘å€‘åœ¨é€™ç¯‡æ–‡ç« ç•¶ä¸­æ¸…æ¥šçš„äº†è§£åˆ° CRNN çš„æ¶æ§‹ï¼Œä»¥åŠ CTC çš„æ¶æ§‹ã€è¨“ç·´çš„åƒæ•¸å„ªåŒ–å’Œå…¶ä¸‰ç¨® Inference æ–¹æ³•ã€‚çœ‹å®Œäº†é€™äº›åŸç†ï¼Œä¹Ÿè©²å‹•æ‰‹è©¦ç©çœ‹çœ‹ï¼Œåœ¨ <a href="https://github.com/GitYCC/crnn-pytorch">GitYCC/crnn-pytorch</a> ä¸­å·²ç¶“æœ‰å·²ç¶“ pretrained çš„æ¨¡å‹å¯ä»¥ä½¿ç”¨ï¼Œä¸å¦¨è·Ÿè‘—ä»¥ä¸‹æ­¥é©Ÿå¯¦éš›å‹•æ‰‹ç©ç©çœ‹ OCR å ´æ™¯è¾¨è­˜å§ï¼</p>
<div class="highlight"><pre><span class="l-Scalar-Plain">$ git clone https://github.com/GitYCC/crnn-pytorch.git</span>
<span class="l-Scalar-Plain">$ cd crnn-pytorch/</span>
<span class="l-Scalar-Plain">$ pip install -r requirements.txt</span>
<span class="l-Scalar-Plain">$ python src/predict.py demo/*.jpg</span>
</pre></div>


<h3>Reference</h3>
<ul>
<li><a href="https://arxiv.org/pdf/1507.05717.pdf">An End-to-End Trainable Neural Network for Image-based Sequence Recognition and Its Application to Scene Text Recognition (2015), Baoguang Shi et al.</a></li>
<li><a href="https://www.cs.toronto.edu/~graves/icml_2006.pdf">Connectionist Temporal Classification: Labelling Unsegmented Sequence Data with Recurrent Neural Networks (2006), Alex Graves et al.</a></li>
<li><a href="https://arxiv.org/pdf/1408.2873.pdf">First-Pass Large Vocabulary Continuous Speech Recognition using Bi-Directional Recurrent DNNs (2014), Awni Y. Hannun et al.</a></li>
<li><a href="https://distill.pub/2017/ctc/">Sequence Modeling With CTC, Awni Hannun.</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/39266552">å¯¹ã€ŠCTC åŸç†åŠå®ç°ã€‹ä¸­çš„ä¸€äº›ç®—æ³•çš„è§£é‡Š</a></li>
</ul>
<script type="text/javascript">if (!document.getElementById('mathjaxscript_pelican_#%@#$@#')) {
    var align = "center",
        indent = "0em",
        linebreak = "false";

    if (false) {
        align = (screen.width < 768) ? "left" : align;
        indent = (screen.width < 768) ? "0em" : indent;
        linebreak = (screen.width < 768) ? 'true' : linebreak;
    }

    var mathjaxscript = document.createElement('script');
    mathjaxscript.id = 'mathjaxscript_pelican_#%@#$@#';
    mathjaxscript.type = 'text/javascript';
    mathjaxscript.src = 'https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.3/latest.js?config=TeX-AMS-MML_HTMLorMML';
    mathjaxscript[(window.opera ? "innerHTML" : "text")] =
        "MathJax.Hub.Config({" +
        "    config: ['MMLorHTML.js']," +
        "    TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'AMS' } }," +
        "    jax: ['input/TeX','input/MathML','output/HTML-CSS']," +
        "    extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']," +
        "    displayAlign: '"+ align +"'," +
        "    displayIndent: '"+ indent +"'," +
        "    showMathMenu: true," +
        "    messageStyle: 'normal'," +
        "    tex2jax: { " +
        "        inlineMath: [ ['\\\\(','\\\\)'] ], " +
        "        displayMath: [ ['$$','$$'] ]," +
        "        processEscapes: true," +
        "        preview: 'TeX'," +
        "    }, " +
        "    'HTML-CSS': { " +
        "        styles: { '.MathJax_Display, .MathJax .mo, .MathJax .mi, .MathJax .mn': {color: 'inherit ! important'} }," +
        "        linebreaks: { automatic: "+ linebreak +", width: '90% container' }," +
        "    }, " +
        "}); " +
        "if ('default' !== 'default') {" +
            "MathJax.Hub.Register.StartupHook('HTML-CSS Jax Ready',function () {" +
                "var VARIANT = MathJax.OutputJax['HTML-CSS'].FONTDATA.VARIANT;" +
                "VARIANT['normal'].fonts.unshift('MathJax_default');" +
                "VARIANT['bold'].fonts.unshift('MathJax_default-bold');" +
                "VARIANT['italic'].fonts.unshift('MathJax_default-italic');" +
                "VARIANT['-tex-mathit'].fonts.unshift('MathJax_default-italic');" +
            "});" +
            "MathJax.Hub.Register.StartupHook('SVG Jax Ready',function () {" +
                "var VARIANT = MathJax.OutputJax.SVG.FONTDATA.VARIANT;" +
                "VARIANT['normal'].fonts.unshift('MathJax_default');" +
                "VARIANT['bold'].fonts.unshift('MathJax_default-bold');" +
                "VARIANT['italic'].fonts.unshift('MathJax_default-italic');" +
                "VARIANT['-tex-mathit'].fonts.unshift('MathJax_default-italic');" +
            "});" +
        "}";
    (document.body || document.getElementsByTagName('head')[0]).appendChild(mathjaxscript);
}
</script>

                    </div> <!-- end entry content -->
                    
                    <div class="entry__pagenav">
                        <div class="entry__nav">
                            <div class="entry__prev">
                                <a href="https://www.ycc.idv.tw/latest_ai_info.html" rel="prev">
                                    <span>Previous Post</span>
                                    è³‡æºæ•´ç†ï¼šè·Ÿä¸ŠAIå‰æ²¿çŸ¥è­˜
                                </a>
                            </div>
                            <div class="entry__next">
                            </div>
                        </div>
                    </div> <!-- end entry__pagenav -->

                    <div class="entry__related">
                    </div> <!-- end entry related -->

                    <div id="disqus-wrapper">
                        <div id="disqus_thread"></div>
                    </div>

                </article> <!-- end column large-full entry-->
            </main>

        </div> <!-- end s-content -->

        <!-- footer
        ================================================== -->
        <footer class="s-footer footer">
            <div class="row">
                <div class="column large-full footer__content">
                    <div class="footer__copyright">
                        <span>Â© Copyright YC Note 2019</span> 
                        <span>Design by <a href="https://www.styleshout.com/">StyleShout</a></span>
                    </div>
                </div>
            </div>

            <div class="go-top">
                <a class="smoothscroll" title="Back to Top" href="#top"></a>
            </div>
        </footer>

    </div> <!-- end s-wrap -->


    <!-- Java Script
    ================================================== -->
    <script src="https://www.ycc.idv.tw/theme/js/jquery-3.2.1.min.js"></script>
    <script src="https://www.ycc.idv.tw/theme/js/plugins.js"></script>
    <script src="https://www.ycc.idv.tw/theme/js/main.js"></script>
    <script>
        var elements = document.getElementsByTagName("h3");
        for(i = 0; i < elements.length; i++)
        {
            elements[i].setAttribute("id", "anchor"+i);
        }
    </script>
    <script type="text/javascript">
        var disqus_config = function () {
            this.page.url = "https://www.ycc.idv.tw/crnn-ctc.html";
            this.page.identifier = "crnn-ctc.html";
            this.page.title = "OCRï¼šCRNN+CTCé–‹æºåŠ è©³ç´°è§£æ";
            this.language = "zh_TW";
        };

       (function() { // DON'T EDIT BELOW THIS LINE
            var d = document, s = d.createElement('script');
            s.src = '//ycnote-1.disqus.com/embed.js';
            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

    <script>
    $(".entry__content img").attr("data-enlargable", "").css("cursor", "zoom-in");
    
    $('img[data-enlargable]').addClass('img-enlargable').click(function(){
        var src = $(this).attr('src');
        $('<div>').css({
            background: 'RGBA(0,0,0,.8) url('+src+') no-repeat center',
            backgroundSize: 'contain',
            borderTop: '40px solid RGBA(0,0,0,0.0)',
            borderBottom: '40px solid RGBA(0,0,0,0.0)',
            width:'100%', height:'100%',
            position:'fixed',
            zIndex:'10000',
            top:'0', left:'0',
            cursor: 'zoom-out'
        }).click(function(){
            $(this).remove();
        }).appendTo('body');
    });
    </script>

</body>